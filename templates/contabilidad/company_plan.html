{% extends 'base.html' %}

{% block title %}Plan de Cuentas - {{ empresa.nombre }} | ECAE{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-8rem)] bg-gradient-to-br from-slate-50 via-blue-50/30 to-slate-100 dark:from-black dark:via-slate-950 dark:to-slate-900 py-6">
  <div class="mx-auto px-4 xl:px-8 max-w-[1600px]">

    {% with current_panel='plan' %}{% include 'contabilidad/_company_header_minimal.html' %}{% endwith %}
    <!-- Botones eliminados: Vista Compacta y Ocultar Panel se integran en header mínimo -->

    {# navegación integrada en header parcial; se elimina nav redundante #}

    <!-- Layout Grid Principal: 5 columnas para más espacio en la tabla -->
    <div id="plan-grid" class="grid gap-4 xl:grid-cols-5 items-start transition-all">
      <!-- Columna izquierda: Formulario Crear Cuenta -->
      <div id="plan-actions" class="space-y-4 xl:col-span-1 transition-all">
        {% if can_edit %}
        <div class="bg-gradient-to-br from-white to-blue-50/30 dark:from-slate-900 dark:to-slate-950 p-5 rounded-xl shadow-lg border-2 border-blue-100 dark:border-slate-800 sticky top-20">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 dark:from-blue-700 dark:to-blue-800 rounded-lg flex items-center justify-center shadow-md">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </div>
            <h2 class="text-sm font-bold text-slate-900 dark:text-slate-100 tracking-wide">Nueva Cuenta</h2>
          </div>
          <form method="post" action="{% url 'contabilidad:add_account' empresa.id %}" class="space-y-3.5">
            {% csrf_token %}
            <div>
              <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 mb-1.5 uppercase tracking-wide">Código *</label>
              <input name="codigo" required class="w-full px-3 py-2.5 border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 rounded-lg text-sm focus:border-blue-500 dark:focus:border-blue-400 focus:ring-3 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all" />
              <p class="mt-1 text-[10px] text-slate-500 dark:text-slate-400">
                <span class="font-semibold">Tipo automático:</span> 1=Activo, 2=Pasivo, 3=Patrimonio, 4=Ingreso, 5=Costo, 6=Gasto
              </p>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 mb-1.5 uppercase tracking-wide">Descripción *</label>
              <input name="descripcion" required class="w-full px-3 py-2.5 border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 rounded-lg text-sm focus:border-blue-500 dark:focus:border-blue-400 focus:ring-3 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all" />
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 mb-1.5 uppercase tracking-wide">Cuenta Padre</label>
              <select name="padre" class="w-full px-2 py-2.5 border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 rounded-lg text-sm focus:border-blue-500 dark:focus:border-blue-400 focus:ring-3 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all">
                <option value="">-- Ninguno --</option>
                {% for p in cuentas %}<option value="{{ p.id }}">{{ p.codigo }} — {{ p.descripcion }}</option>{% endfor %}
              </select>
            </div>
            <div class="bg-slate-50 dark:bg-slate-950 -mx-5 -mb-5 px-5 py-3 rounded-b-xl border-t border-slate-200 dark:border-slate-800">
              <label class="inline-flex items-center text-xs font-bold text-slate-700 dark:text-slate-300 cursor-pointer">
                <input type="checkbox" name="es_auxiliar" value="1" class="w-4 h-4 text-blue-600 border-slate-300 dark:border-slate-700 dark:bg-slate-800 rounded focus:ring-2 focus:ring-blue-200 dark:focus:ring-blue-900 mr-2">Cuenta Transaccional
              </label>
            </div>
            <div class="-mx-5 -mb-5 px-5 pb-5">
              <button class="w-full px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 dark:from-blue-700 dark:to-blue-800 hover:from-blue-700 hover:to-blue-800 dark:hover:from-blue-600 dark:hover:to-blue-700 text-white rounded-lg text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-200">Crear Cuenta</button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>

      <!-- Columna principal: Tabla (ahora ocupa 3 columnas en lugar de 2) -->
      <div id="plan-main" class="xl:col-span-3 space-y-4 transition-all">

    {# Se elimina formulario duplicado; el formulario lateral permanece #}

    <!-- Tabla de Cuentas -->
    <div class="bg-white dark:bg-slate-900 p-5 rounded-xl shadow-lg border border-slate-200 dark:border-slate-800">
      <div class="flex items-center gap-2 mb-4 pb-3 border-b-2 border-blue-200 dark:border-slate-800">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 dark:from-blue-700 dark:to-blue-800 rounded-lg flex items-center justify-center shadow-md">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
        </div>
        <h2 class="text-sm font-bold text-slate-900 dark:text-slate-100 uppercase tracking-wide">Catálogo de Cuentas</h2>
      </div>
      {% if cuentas %}
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse text-xs" id="tabla-plan">
            <thead>
              <tr class="bg-gradient-to-r from-slate-100 to-slate-50 dark:from-slate-800 dark:to-slate-900 border-b-2 border-slate-300 dark:border-slate-700">
                <th class="px-3 py-3 text-left font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wider">Código</th>
                <th class="px-3 py-3 text-left font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wider">Descripción</th>
                <th class="px-3 py-3 text-left font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wider">Nivel</th>
                <th class="px-3 py-3 text-left font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wider">Tipo</th>
                <th class="px-3 py-3 text-left font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wider">Naturaleza</th>
                <th class="px-3 py-3 text-left font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wider">Estado</th>
                {% if can_edit %}<th class="px-3 py-3 text-center font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wider">Acciones</th>{% endif %}
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
              {% for c in cuentas %}
                <tr class="group transition-all duration-200 {% if c.level == 0 %}bg-gradient-to-r from-blue-50 via-indigo-50 to-blue-50 dark:from-slate-800 dark:via-slate-900 dark:to-slate-800 hover:from-blue-100 hover:via-indigo-100 hover:to-blue-100 dark:hover:from-slate-700 dark:hover:via-slate-800 dark:hover:to-slate-700 border-t-2 border-b-2 border-blue-300 dark:border-slate-700 shadow-sm{% else %}hover:bg-slate-50/70 dark:hover:bg-slate-800/50{% endif %} {% if not c.activa %}opacity-60{% endif %}" data-codigo="{{ c.codigo|lower }}" data-descripcion="{{ c.descripcion|lower }}" data-tipo="{{ c.tipo }}" data-naturaleza="{{ c.naturaleza }}">
                  <td class="px-3 {% if c.level == 0 %}py-3.5{% else %}py-2.5{% endif %}">
                    <code class="font-mono {% if c.level == 0 %}text-sm font-bold text-blue-900 dark:text-blue-400 bg-gradient-to-r from-blue-100 to-indigo-100 dark:from-blue-950 dark:to-indigo-950 px-3 py-1.5 shadow-sm{% else %}text-[11px] text-slate-800 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 px-2.5 py-1{% endif %} rounded-lg border border-slate-200/50 dark:border-slate-700">{{ c.codigo }}</code>
                  </td>
                  <td class="px-3 {% if c.level == 0 %}py-3{% else %}py-2{% endif %}">
                    <div class="flex items-center">
                      <button type="button" class="mr-2 {% if c.level == 0 %}text-blue-700 dark:text-blue-400{% else %}text-slate-500 dark:text-slate-400{% endif %} hover:text-slate-900 dark:hover:text-slate-100 {% if c.level == 0 %}text-sm font-bold{% else %}text-xs font-semibold{% endif %} toggle-children" data-codigo="{{ c.codigo }}" aria-label="Toggle">
                        {% if c.tiene_hijas %}<span class="inline-block w-4 text-center">+</span>{% else %}<span class="inline-block w-4"></span>{% endif %}
                      </button>
                      <span class="block {% if c.level == 0 %}text-sm font-bold text-blue-900 dark:text-blue-400 uppercase tracking-wide{% else %}text-xs text-slate-800 dark:text-slate-200{% endif %} truncate {% if c.level == 1 %}ml-2{% elif c.level == 2 %}ml-4{% elif c.level == 3 %}ml-6{% elif c.level > 3 %}ml-8{% endif %}" id="desc-{{ c.id }}">{{ c.descripcion }}</span>
                    </div>
                  </td>
                  <td class="px-3 {% if c.level == 0 %}py-3.5{% else %}py-2.5{% endif %}">
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg {% if c.level == 0 %}text-xs font-bold bg-gradient-to-r from-blue-100 to-indigo-100 dark:from-blue-950 dark:to-indigo-950 text-blue-900 dark:text-blue-400 border border-blue-200 dark:border-blue-900{% else %}text-[10px] font-semibold bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700{% endif %}">{{ c.structural_type }}</span>
                  </td>
                  <td class="px-3 {% if c.level == 0 %}py-3.5{% else %}py-2.5{% endif %}">
                    <span class="{% if c.level == 0 %}text-sm font-bold text-blue-900 dark:text-blue-400{% else %}text-xs font-medium text-slate-700 dark:text-slate-300{% endif %}">{{ c.tipo }}</span>
                  </td>
                  <td class="px-3 {% if c.level == 0 %}py-3.5{% else %}py-2.5{% endif %}">
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg {% if c.level == 0 %}text-xs{% else %}text-[10px]{% endif %} font-bold border {% if c.naturaleza == 'Deudora' %}bg-gradient-to-r from-red-50 to-red-100 dark:from-red-950 dark:to-red-900 text-red-800 dark:text-red-400 border-red-200 dark:border-red-900{% else %}bg-gradient-to-r from-emerald-50 to-emerald-100 dark:from-emerald-950 dark:to-emerald-900 text-emerald-800 dark:text-emerald-400 border-emerald-200 dark:border-emerald-900{% endif %}">
                      {% if c.naturaleza == 'Deudora' %}
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                      {% else %}
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                      {% endif %}
                      {{ c.get_naturaleza_display }}
                    </span>
                  </td>
                  <td class="px-3 {% if c.level == 0 %}py-3.5{% else %}py-2.5{% endif %}">
                    <div class="flex items-center gap-2">
                      {% if c.es_auxiliar %}
                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-lg {% if c.level == 0 %}text-xs font-bold bg-purple-100 dark:bg-purple-950 text-purple-800 dark:text-purple-400 border border-purple-200 dark:border-purple-900{% else %}text-[10px] font-semibold bg-purple-50 dark:bg-purple-950 text-purple-700 dark:text-purple-400 border border-purple-200 dark:border-purple-900{% endif %}">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path></svg>
                        Trs
                      </span>
                      {% endif %}
                      {% if not c.activa %}<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-lg text-[10px] font-bold bg-red-100 dark:bg-red-950 text-red-800 dark:text-red-400 border border-red-200 dark:border-red-900"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>Inactiva</span>{% endif %}
                    </div>
                  </td>
                  {% if can_edit %}
                  <td class="px-3 {% if c.level == 0 %}py-3{% else %}py-2{% endif %}">
                    <div class="flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      <!-- Toggle Activa/Inactiva -->
                      <form method="post" action="{% url 'contabilidad:toggle_account_status' empresa.id c.id %}" class="inline toggle-form" data-action="{% if c.activa %}desactivar{% else %}activar{% endif %}" data-codigo="{{ c.codigo }}">
                        {% csrf_token %}
                        <button type="submit" class="p-1.5 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors" title="{% if c.activa %}Desactivar{% else %}Activar{% endif %} cuenta">
                          {% if c.activa %}
                          <svg class="w-4 h-4 text-amber-600 dark:text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                          </svg>
                          {% else %}
                          <svg class="w-4 h-4 text-green-600 dark:text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                          </svg>
                          {% endif %}
                        </button>
                      </form>

                      <!-- Editar Descripción -->
                      <button type="button" class="p-1.5 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors edit-desc-btn" data-id="{{ c.id }}" data-codigo="{{ c.codigo }}" title="Editar descripción">
                        <svg class="w-4 h-4 text-blue-600 dark:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </button>

                      <!-- Eliminar -->
                      <form method="post" action="{% url 'contabilidad:delete_account' empresa.id c.id %}" class="inline delete-form" data-codigo="{{ c.codigo }}">
                        {% csrf_token %}
                        <button type="submit" class="p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-950 transition-colors" title="Eliminar cuenta">
                          <svg class="w-4 h-4 text-red-600 dark:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </td>
                  {% endif %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-12">
          <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-lg flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <p class="text-slate-600 dark:text-slate-300 font-medium">No hay cuentas definidas</p>
          <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Comienza agregando tu primera cuenta contable</p>
        </div>
      {% endif %}
    </div>
    </div> <!-- fin col principal -->

      <!-- Columna derecha: Filtros -->
      <div id="plan-sidebar" class="space-y-4 xl:col-span-1 transition-all">
        <div class="bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-950 p-5 rounded-xl shadow-lg border-2 border-slate-200 dark:border-slate-800 sticky top-20">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-10 h-10 bg-gradient-to-br from-slate-700 to-slate-800 dark:from-slate-600 dark:to-slate-700 rounded-lg flex items-center justify-center shadow-md">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
            </div>
            <h3 class="text-sm font-bold text-slate-900 dark:text-slate-100">Filtros</h3>
          </div>
          <form id="plan-filter-form" class="space-y-3.5">
            <div>
              <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 mb-1.5 uppercase tracking-wide">Buscar</label>
              <input type="text" id="plan-search" placeholder="Código o descripción" class="w-full px-3 py-2.5 border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 rounded-lg focus:ring-3 focus:ring-blue-100 dark:focus:ring-blue-900 focus:border-blue-500 dark:focus:border-blue-600 transition-all text-sm" />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 mb-1.5 uppercase tracking-wide">Tipo</label>
                <select id="plan-tipo" class="w-full px-2 py-2.5 border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 rounded-lg text-sm focus:ring-3 focus:ring-blue-100 dark:focus:ring-blue-900 focus:border-blue-500 dark:focus:border-blue-600 transition-all">
                  <option value="">Todos</option>
                  <option>Activo</option>
                  <option>Pasivo</option>
                  <option>Patrimonio</option>
                  <option>Ingreso</option>
                  <option>Costo</option>
                  <option>Gasto</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-700 dark:text-slate-300 mb-1.5 uppercase tracking-wide">Naturaleza</label>
                <select id="plan-naturaleza" class="w-full px-2 py-2.5 border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 rounded-lg text-sm focus:ring-3 focus:ring-blue-100 dark:focus:ring-blue-900 focus:border-blue-500 dark:focus:border-blue-600 transition-all">
                  <option value="">Todas</option>
                  <option>Deudora</option>
                  <option>Acreedora</option>
                </select>
              </div>
            </div>
            <div class="flex items-center justify-between pt-1">
              <button type="button" id="btn-expand-todos" class="text-xs font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Expandir todos</button>
              <button type="button" id="btn-colapsar-todos" class="text-xs font-semibold text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">Colapsar</button>
            </div>
          </form>
        </div>
      </div>
    </div> <!-- fin grid -->

    <!-- Comentarios del Docente - Componente Unificado -->
    {% if empresa.visible_to_supervisor %}
      {% include 'contabilidad/_comments_section.html' with comments=comments section_code='PL' section_name='Plan de Cuentas' %}
    {% endif %}

  </div>
</div>
  <script>
    (function(){
      const search = document.getElementById('plan-search');
      const tipo = document.getElementById('plan-tipo');
      const naturaleza = document.getElementById('plan-naturaleza');
      const rows = Array.from(document.querySelectorAll('#tabla-plan tbody tr'));
      function aplicarFiltro(){
        const q = (search.value || '').trim().toLowerCase();
        const t = tipo.value;
        const n = naturaleza.value;
        rows.forEach(r => {
          let visible = true;
          const codigo = r.dataset.codigo;
          const descripcion = r.dataset.descripcion;
          const rt = r.dataset.tipo;
          const rn = r.dataset.naturaleza;
          if (q) visible = codigo.includes(q) || descripcion.includes(q);
          if (visible && t) visible = rt === t;
          if (visible && n) visible = rn === n;
          r.style.display = visible ? '' : 'none';
        });
      }
      [search, tipo, naturaleza].forEach(el => el && el.addEventListener('input', aplicarFiltro));

      const toggleButtons = document.querySelectorAll('.toggle-children');
      toggleButtons.forEach(btn => {
        if (!btn.querySelector('span') || btn.querySelector('span').textContent.trim() !== '+') return;
        btn.addEventListener('click', () => {
          const prefix = btn.dataset.codigo + '.';
          const isExpanding = btn.dataset.state !== 'open';
          rows.forEach(r => {
            if (r.dataset.codigo.startsWith(prefix)) {
              r.style.display = isExpanding ? '' : 'none';
            }
          });
          btn.dataset.state = isExpanding ? 'open' : 'closed';
          btn.querySelector('span').textContent = isExpanding ? '−' : '+';
        });
      });
      document.getElementById('btn-expand-todos').addEventListener('click', () => {
        rows.forEach(r => r.style.display='');
        toggleButtons.forEach(b => { if (b.dataset.codigo){ b.dataset.state='open'; if (b.querySelector('span')) b.querySelector('span').textContent='−'; }});
      });
      document.getElementById('btn-colapsar-todos').addEventListener('click', () => {
        rows.forEach(r => {
          const code = r.dataset.codigo;
          const level = (code.match(/\./g) || []).length;
          r.style.display = level <= 1 ? '' : 'none';
        });
        toggleButtons.forEach(b => { if (b.dataset.codigo){ b.dataset.state='closed'; if (b.querySelector('span')) b.querySelector('span').textContent='+'; }});
      });

      // Panel toggle button in minimal header
      const panelBtn = document.getElementById('panel-toggle-btn');
      const sidebar = document.getElementById('plan-sidebar');
      const actions = document.getElementById('plan-actions');
      const main = document.getElementById('plan-main');
      let hiddenPanels = false;
      if(panelBtn){
        panelBtn.addEventListener('click',()=>{
          hiddenPanels = !hiddenPanels;
          if(hiddenPanels){
            sidebar.classList.add('hidden');
            actions.classList.add('hidden');
            main.classList.remove('xl:col-span-2');
            main.classList.add('xl:col-span-4');
            panelBtn.textContent='Mostrar Paneles';
          }else{
            sidebar.classList.remove('hidden');
            actions.classList.remove('hidden');
            main.classList.remove('xl:col-span-4');
            main.classList.add('xl:col-span-2');
            panelBtn.textContent='Ocultar Paneles';
          }
        });
      }

      // Toggle status con customConfirm
      document.querySelectorAll('.toggle-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const action = form.dataset.action;
          const codigo = form.dataset.codigo;
          const confirmed = await customConfirm(
            `Esta acción ${action === 'desactivar' ? 'ocultará' : 'mostrará'} la cuenta en el sistema.`,
            `¿${action.charAt(0).toUpperCase() + action.slice(1)} cuenta ${codigo}?`,
            action === 'desactivar' ? 'Desactivar' : 'Activar'
          );
          if (confirmed) {
            form.submit();
          }
        });
      });

      // Eliminar con customConfirm
      document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const codigo = form.dataset.codigo;
          const confirmed = await customConfirm(
            `Esta acción es permanente y no se puede deshacer. Solo es posible si la cuenta no tiene transacciones ni subcuentas.`,
            `¿Eliminar cuenta ${codigo}?`,
            'Eliminar',
            'Cancelar'
          );
          if (confirmed) {
            form.submit();
          }
        });
      });

      // Editar descripción con customPrompt
      document.querySelectorAll('.edit-desc-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const codigo = btn.dataset.codigo;
          const currentDesc = document.getElementById(`desc-${id}`).textContent.trim();
          const newDesc = await customPrompt(`Cuenta ${codigo}`, currentDesc, 'Editar Descripción');

          if (newDesc !== null && newDesc.trim() !== '' && newDesc.trim() !== currentDesc) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/contabilidad/{{ empresa.id }}/plan/${id}/edit-description/`;

            const csrf = document.createElement('input');
            csrf.type = 'hidden';
            csrf.name = 'csrfmiddlewaretoken';
            csrf.value = '{{ csrf_token }}';

            const descInput = document.createElement('input');
            descInput.type = 'hidden';
            descInput.name = 'descripcion';
            descInput.value = newDesc.trim();

            form.appendChild(csrf);
            form.appendChild(descInput);
            document.body.appendChild(form);
            form.submit();
          }
        });
      });
    })();
  </script>
  <!-- Compact mode removed -->
{% endblock %}
