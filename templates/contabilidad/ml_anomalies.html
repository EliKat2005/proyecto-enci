{% extends "base.html" %}
{% load static %}

{% block title %}Anomal√≠as - {{ empresa.nombre }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-dark-bg py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                        üö® Detecci√≥n de Anomal√≠as
                    </h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Isolation Forest - <span class="font-semibold">{{ empresa.nombre }}</span>
                    </p>
                </div>
                <a href="{% url 'contabilidad:ml_dashboard' empresa.id %}"
                   class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-surface hover:bg-gray-50 dark:hover:bg-gray-700">
                    ‚Üê Dashboard ML
                </a>
            </div>
        </div>

        <!-- Navegaci√≥n -->
        <div class="mb-8">
            <nav class="flex space-x-4 overflow-x-auto">
                <a href="{% url 'contabilidad:ml_dashboard' empresa.id %}"
                   class="px-4 py-2 rounded-lg font-medium text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-dark-surface">
                    üìä Dashboard
                </a>
                <a href="{% url 'contabilidad:ml_analytics' empresa.id %}"
                   class="px-4 py-2 rounded-lg font-medium text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-dark-surface">
                    üìà Analytics
                </a>
                <a href="{% url 'contabilidad:ml_predictions' empresa.id %}"
                   class="px-4 py-2 rounded-lg font-medium text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-dark-surface">
                    üîÆ Predicciones
                </a>
                <a href="{% url 'contabilidad:ml_anomalies' empresa.id %}"
                   class="px-4 py-2 rounded-lg font-medium bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300">
                    üö® Anomal√≠as
                </a>
                <a href="{% url 'contabilidad:ml_embeddings' empresa.id %}"
                   class="px-4 py-2 rounded-lg font-medium text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-dark-surface">
                    üß† B√∫squeda Sem√°ntica
                </a>
            </nav>
        </div>

        <!-- Filtros -->
        <div class="bg-white dark:bg-dark-surface rounded-lg shadow p-6 mb-8 border border-gray-200 dark:border-dark-border">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Per√≠odo
                        </label>
                        <select id="periodo-anomalias" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-dark-bg dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="3">√öltimos 3 meses</option>
                            <option value="6" selected>√öltimos 6 meses</option>
                            <option value="12">√öltimos 12 meses</option>
                            <option value="all">Todo el per√≠odo</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Umbral
                        </label>
                        <select id="umbral-anomalias" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-dark-bg dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="3.0">Estricto (Z > 3.0)</option>
                            <option value="2.5" selected>Normal (Z > 2.5)</option>
                            <option value="2.0">Relajado (Z > 2.0)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Severidad
                        </label>
                        <select id="severidad-filter" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-dark-bg dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="all" selected>Todas</option>
                            <option value="alta">Alta</option>
                            <option value="media">Media</option>
                            <option value="baja">Baja</option>
                        </select>
                    </div>

                    <div class="pt-7">
                        <button onclick="detectarAnomalias()"
                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Detectar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="anomalies-summary">
            <div class="bg-white dark:bg-dark-surface rounded-lg shadow-lg p-6 border border-gray-200 dark:border-dark-border">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Anomal√≠as</p>
                    <div class="bg-red-100 dark:bg-red-900/30 rounded-full p-2">
                        <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
                <p id="total-anomalias" class="text-2xl font-bold text-red-600 dark:text-red-400 mb-1">0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Transacciones at√≠picas</p>
            </div>
            <div class="bg-white dark:bg-dark-surface rounded-lg shadow-lg p-6 border border-gray-200 dark:border-dark-border">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Severidad Alta</p>
                    <div class="bg-red-100 dark:bg-red-900/30 rounded-full p-2">
                        <svg class="w-5 h-5 text-red-700 dark:text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
                <p id="high-severity" class="text-2xl font-bold text-red-700 dark:text-red-300 mb-1">0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Z-score > 3.0</p>
            </div>
            <div class="bg-white dark:bg-dark-surface rounded-lg shadow-lg p-6 border border-gray-200 dark:border-dark-border">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Severidad Media</p>
                    <div class="bg-orange-100 dark:bg-orange-900/30 rounded-full p-2">
                        <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <p id="medium-severity" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-1">0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">2.0 < Z-score ‚â§ 3.0</p>
            </div>
            <div class="bg-white dark:bg-dark-surface rounded-lg shadow-lg p-6 border border-gray-200 dark:border-dark-border">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Monto Total</p>
                    <div class="bg-blue-100 dark:bg-blue-900/30 rounded-full p-2">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <p id="monto-afectado" class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-1">$0</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Suma de anomal√≠as</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-anomalies" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600 dark:text-gray-400">Analizando transacciones...</p>
        </div>

        <!-- Distribuci√≥n Chart -->
        <div id="distribution-chart" class="hidden bg-white dark:bg-dark-surface rounded-lg shadow-lg p-6 mb-8 border border-gray-200 dark:border-dark-border">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Distribuci√≥n de Z-Scores</h3>
            <div class="h-64 mb-4">
                <canvas id="anomalyDistributionChart"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 border-l-4 border-blue-500">
                    <p class="text-xs text-gray-700 dark:text-gray-300">
                        <strong>Interpretaci√≥n:</strong> El Z-score mide cu√°ntas desviaciones est√°ndar se aleja una transacci√≥n del promedio. Valores altos indican comportamientos at√≠picos.
                    </p>
                </div>
                <div id="anomaly-interpretation" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border-l-4 border-gray-400">
                    <p class="text-xs text-gray-700 dark:text-gray-300">
                        <strong>Estado:</strong> <span id="interpretation-text">Detecta anomal√≠as para ver el an√°lisis.</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Anomalies List -->
        <div id="anomalies-list" class="space-y-4 hidden">
            <!-- Populated by JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-12 bg-white dark:bg-dark-surface rounded-lg shadow-lg border border-gray-200 dark:border-dark-border">
            <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">Sin anomal√≠as detectadas</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">No se encontraron transacciones an√≥malas en el per√≠odo seleccionado</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const empresaId = {{ empresa.id }};
let distributionChart = null;
let ultimasAnomalias = []; // Para exportar

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function detectarAnomalias() {
    const periodo = document.getElementById('periodo-anomalias').value;
    const umbral = document.getElementById('umbral-anomalias').value;
    const severidad = document.getElementById('severidad-filter').value;

    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('anomalies-list').classList.add('hidden');
    document.getElementById('distribution-chart').classList.add('hidden');
    document.getElementById('loading-anomalies').classList.remove('hidden');

    try {
        const meses = periodo === 'all' ? 999 : parseInt(periodo);
        const url = `/contabilidad/api/ml/anomalies/${empresaId}/detectar/?meses=${meses}&umbral=${Math.abs(parseFloat(umbral))}`;

        const response = await fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error ${response.status}`);
        }

        const data = await response.json();

        mostrarAnomalias(data, severidad);

    } catch (error) {
        alert('Error al detectar anomal√≠as: ' + error.message);
        document.getElementById('loading-anomalies').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
    }
}

function getSeverity(zScore) {
    // El backend ya env√≠a 'severidad', pero calculamos tambi√©n por z_score
    if (zScore > 3) return { level: 'alta', label: 'Alta', color: 'red', emoji: 'üî¥' };
    if (zScore > 2) return { level: 'media', label: 'Media', color: 'orange', emoji: 'üü°' };
    return { level: 'baja', label: 'Baja', color: 'yellow', emoji: 'üü°' };
}

function mostrarAnomalias(data, filterSeveridad) {
    document.getElementById('loading-anomalies').classList.add('hidden');

    // El backend devuelve 'anomalies' con: z_score, severidad, monto, cuenta_codigo, cuenta_descripcion
    const anomalias = data.anomalies || [];

    // Guardar para exportar
    ultimasAnomalias = anomalias;

    // Habilitar bot√≥n de exportar
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
        exportBtn.disabled = anomalias.length === 0;
    }

    // Filtrar por severidad si es necesario
    const filtered = filterSeveridad === 'all' ? anomalias :
        anomalias.filter(a => a.severidad === filterSeveridad);

    // Actualizar tarjetas de resumen
    document.getElementById('total-anomalias').textContent = filtered.length;

    const highCount = filtered.filter(a => a.severidad === 'alta').length;
    const mediumCount = filtered.filter(a => a.severidad === 'media').length;

    document.getElementById('high-severity').textContent = highCount;
    document.getElementById('medium-severity').textContent = mediumCount;

    const montoTotal = filtered.reduce((sum, a) => sum + a.monto, 0);
    document.getElementById('monto-afectado').textContent =
        new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(montoTotal);

    if (filtered.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        return;
    }

    // Crear gr√°fico de distribuci√≥n
    crearGraficoDistribucion(anomalias);
    document.getElementById('distribution-chart').classList.remove('hidden');

    // An√°lisis de interpretaci√≥n
    const promedioZScore = anomalias.reduce((sum, a) => sum + a.z_score, 0) / anomalias.length;
    let interpretacion = '';
    const interpEl = document.getElementById('anomaly-interpretation');

    if (highCount > filtered.length * 0.3) {
        interpretacion = `‚ö†Ô∏è ${(highCount/filtered.length*100).toFixed(0)}% de anomal√≠as son de alta severidad. Se recomienda revisi√≥n urgente.`;
        interpEl.className = 'bg-red-50 dark:bg-red-900/20 rounded-lg p-3 border-l-4 border-red-500';
    } else if (filtered.length > 20) {
        interpretacion = `üìä Se detectaron ${filtered.length} anomal√≠as. Considere revisar las de mayor Z-score primero.`;
        interpEl.className = 'bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 border-l-4 border-yellow-500';
    } else if (filtered.length > 0) {
        interpretacion = `‚úÖ ${filtered.length} anomal√≠as detectadas. Sistema operando dentro de par√°metros normales.`;
        interpEl.className = 'bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border-l-4 border-green-500';
    }
    document.getElementById('interpretation-text').textContent = interpretacion;

    // Mostrar lista de anomal√≠as
    const container = document.getElementById('anomalies-list');
    container.innerHTML = '';
    container.classList.remove('hidden');

    filtered.forEach((anomalia, index) => {
        const severity = getSeverity(anomalia.z_score);
        const card = document.createElement('div');
        card.className = `bg-white dark:bg-dark-surface rounded-lg shadow-lg p-6 border-l-4 border-${severity.color}-500 border border-gray-200 dark:border-dark-border hover:shadow-xl transition-shadow`;

        card.innerHTML = `
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-3">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-${severity.color}-100 dark:bg-${severity.color}-900/30 text-${severity.color}-800 dark:text-${severity.color}-300">
                            ${severity.emoji} ${severity.label}
                        </span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">${anomalia.fecha}</span>
                        <span class="text-xs text-gray-400 dark:text-gray-500">#${anomalia.numero_asiento || anomalia.asiento_id}</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Cuenta</p>
                            <p class="text-sm font-medium text-gray-900 dark:text-white">${anomalia.cuenta_codigo}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${anomalia.cuenta_descripcion}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Monto</p>
                            <p class="text-lg font-bold text-${severity.color}-600 dark:text-${severity.color}-400">
                                ${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(anomalia.monto)}
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Z-Score</p>
                            <p class="text-lg font-mono font-bold text-${severity.color}-600 dark:text-${severity.color}-400">
                                ${anomalia.z_score.toFixed(2)}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${anomalia.z_score.toFixed(1)}œÉ del promedio</p>
                        </div>
                    </div>

                    ${anomalia.descripcion ? `
                    <div class="mt-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Descripci√≥n:</p>
                        <p class="text-sm text-gray-700 dark:text-gray-300">${anomalia.descripcion}</p>
                    </div>
                    ` : ''}

                    ${anomalia.tercero ? `
                    <div class="mt-2 flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span>Tercero: ${anomalia.tercero}</span>
                    </div>
                    ` : ''}

                    <!-- Explicaci√≥n autom√°tica -->
                    <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-2 border-blue-500">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 mr-2 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <p class="text-xs font-semibold text-blue-800 dark:text-blue-300 mb-1">An√°lisis autom√°tico:</p>
                                <p class="text-xs text-blue-700 dark:text-blue-300">${generarExplicacionAutomatica(anomalia)}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ml-4">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-${severity.color}-100 dark:bg-${severity.color}-900/30 text-${severity.color}-600 dark:text-${severity.color}-400 font-bold">
                        ${index + 1}
                    </span>
                </div>
            </div>
        `;

        container.appendChild(card);
    });
}

function crearGraficoDistribucion(anomalias) {
    const canvas = document.getElementById('anomalyDistributionChart');
    if (!canvas) return;

    if (distributionChart) {
        distributionChart.destroy();
    }

    // Agrupar por rangos de Z-score
    const rangos = {
        '2.0-2.5': 0,
        '2.5-3.0': 0,
        '3.0-3.5': 0,
        '3.5-4.0': 0,
        '4.0+': 0
    };

    anomalias.forEach(a => {
        const z = a.z_score;
        if (z < 2.5) rangos['2.0-2.5']++;
        else if (z < 3.0) rangos['2.5-3.0']++;
        else if (z < 3.5) rangos['3.0-3.5']++;
        else if (z < 4.0) rangos['3.5-4.0']++;
        else rangos['4.0+']++;
    });

    const isDark = document.documentElement.classList.contains('dark');

    distributionChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: Object.keys(rangos),
            datasets: [{
                label: 'N√∫mero de Anomal√≠as',
                data: Object.values(rangos),
                backgroundColor: [
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(251, 146, 60, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(220, 38, 38, 0.8)',
                    'rgba(185, 28, 28, 0.8)',
                ],
                borderColor: [
                    'rgb(251, 191, 36)',
                    'rgb(251, 146, 60)',
                    'rgb(239, 68, 68)',
                    'rgb(220, 38, 38)',
                    'rgb(185, 28, 28)',
                ],
                borderWidth: 2,
                borderRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return `Anomal√≠as: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: isDark ? '#9ca3af' : '#6b7280',
                        stepSize: 1
                    },
                    grid: {
                        color: isDark ? 'rgba(75, 85, 99, 0.3)' : 'rgba(229, 231, 235, 0.8)',
                    }
                },
                x: {
                    ticks: {
                        color: isDark ? '#d1d5db' : '#4b5563',
                        font: { size: 11, weight: '500' }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Funci√≥n para generar explicaciones autom√°ticas de anomal√≠as
function generarExplicacionAutomatica(anomalia) {
    const z = Math.abs(anomalia.z_score);
    let explicacion = '';

    if (z >= 3.0) {
        const porcentaje = Math.round((z - 1) * 50);
        explicacion = `Monto extremadamente inusual, ${porcentaje}% superior al comportamiento normal de esta cuenta. `;
    } else if (z >= 2.5) {
        const porcentaje = Math.round((z - 1) * 40);
        explicacion = `Monto significativamente diferente al promedio, ${porcentaje}% fuera del rango esperado. `;
    } else if (z >= 2.0) {
        explicacion = `Transacci√≥n moderadamente inusual para el patr√≥n hist√≥rico de esta cuenta. `;
    }

    // Agregar contexto seg√∫n el tipo de cuenta
    const codigoCuenta = anomalia.cuenta_codigo || '';
    if (codigoCuenta.startsWith('1')) {
        explicacion += 'Revisar activos.';
    } else if (codigoCuenta.startsWith('2')) {
        explicacion += 'Verificar pasivos.';
    } else if (codigoCuenta.startsWith('3')) {
        explicacion += 'Validar patrimonio.';
    } else if (codigoCuenta.startsWith('4')) {
        explicacion += 'Confirmar ingresos.';
    } else if (codigoCuenta.startsWith('5')) {
        explicacion += 'Verificar costos.';
    } else if (codigoCuenta.startsWith('6')) {
        explicacion += 'Revisar gastos.';
    }

    return explicacion;
}

// Auto-carga al inicio
document.addEventListener('DOMContentLoaded', () => {
    detectarAnomalias();
});
</script>
{% endblock %}
