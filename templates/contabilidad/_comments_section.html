{% comment %}
  Componente reutilizable para la sección de comentarios del docente

  Parámetros requeridos:
  - empresa: objeto Empresa
  - section_code: código de la sección (PL, DI, MA, BC, EF)
  - is_supervisor: boolean
  - is_docente: boolean
  - comments: QuerySet de comentarios filtrados por sección

  Condiciones de visibilidad:
  - Para estudiantes: Solo visible si empresa.visible_to_supervisor Y hay comentarios
  - Para docentes supervisores: Siempre visible si empresa.visible_to_supervisor
{% endcomment %}

<!-- Sección de Comentarios: Diseño compacto y discreto -->
{% if empresa.visible_to_supervisor %}
  {% if comments or is_supervisor %}
<div id="comments-section" class="bg-white dark:bg-slate-900 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800">

  <!-- Header compacto -->
  <div class="bg-slate-50 dark:bg-slate-800 px-4 py-2.5 border-b border-slate-200 dark:border-slate-700">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 text-emerald-600 dark:text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
        </svg>
        <h2 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Retroalimentación</h2>
      </div>
      {% if comments %}
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 dark:bg-emerald-950 text-emerald-700 dark:text-emerald-400">
          {{ comments|length }}
        </span>
      {% endif %}
    </div>
  </div>

  <!-- Contenido -->
  <div class="p-4">
    <!-- Historial de comentarios (visible para estudiantes y docentes) -->
    {% if comments %}
      <div class="space-y-2 mb-3">
        {% for comment in comments %}
          <div class="p-3 bg-emerald-50/50 dark:bg-emerald-950/20 rounded-lg border border-emerald-100 dark:border-emerald-900">
            <div class="flex items-start gap-2">
              <div class="flex-shrink-0 w-7 h-7 bg-emerald-600 dark:bg-emerald-700 rounded-full flex items-center justify-center text-white font-semibold text-xs">
                {{ comment.author.get_full_name|slice:":1"|upper|default:comment.author.username|slice:":1"|upper }}
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs font-semibold text-slate-700 dark:text-slate-300">{{ comment.author.get_full_name|default:comment.author.username }}</span>
                  <time class="text-xs text-slate-500 dark:text-slate-400">{{ comment.created_at|date:"d/m/Y H:i" }}</time>
                </div>
                <p class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-line">{{ comment.content }}</p>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Formulario para Docentes - Botón discreto -->
    {% if is_supervisor %}
      <div class="{% if comments %}mt-3 pt-3 border-t border-slate-200 dark:border-slate-700{% endif %}">
        <button
          type="button"
          id="toggle-comment-form-{{ section_code }}"
          onclick="toggleCommentForm('{{ section_code }}')"
          class="w-full px-3 py-2 text-sm bg-white dark:bg-slate-800 hover:bg-emerald-50 dark:hover:bg-emerald-950/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800 hover:border-emerald-300 dark:hover:border-emerald-700 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span>Agregar comentario</span>
          <svg class="w-3 h-3 transition-transform duration-200" id="toggle-icon-{{ section_code }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Formulario compacto (oculto por defecto) -->
        <div id="comment-form-{{ section_code }}" class="hidden mt-3">
          <form method="post" action="{% url 'contabilidad:add_comment' empresa.id section_code %}" onsubmit="return validateComment(this)">
            {% csrf_token %}
            <textarea
              name="content"
              rows="3"
              class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-gray-100 rounded-lg focus:border-emerald-500 focus:ring-1 focus:ring-emerald-200 dark:focus:ring-emerald-800 transition-all resize-none"
              placeholder="Escribe tu retroalimentación..."
            ></textarea>
            <div class="flex justify-end gap-2 mt-2">
              <button
                type="button"
                onclick="toggleCommentForm('{{ section_code }}')"
                class="px-3 py-1.5 text-xs text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium transition-colors">
                Cancelar
              </button>
              <button
                type="submit"
                class="px-4 py-1.5 text-xs bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold shadow-sm transition-all duration-150 flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <span>Publicar</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</div>
  {% endif %}
{% endif %}

<script>
  function toggleCommentForm(sectionCode) {
    const form = document.getElementById('comment-form-' + sectionCode);
    const button = document.getElementById('toggle-comment-form-' + sectionCode);
    const icon = document.getElementById('toggle-icon-' + sectionCode);

    if (form.classList.contains('hidden')) {
      // Mostrar formulario
      form.classList.remove('hidden');
      // Animar el icono
      icon.style.transform = 'rotate(180deg)';
      // Scroll suave al formulario
      setTimeout(() => {
        form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
      // Enfocar el textarea
      setTimeout(() => {
        const textarea = form.querySelector('textarea');
        if (textarea) textarea.focus();
      }, 350);
    } else {
      // Ocultar formulario
      form.classList.add('hidden');
      icon.style.transform = 'rotate(0deg)';
    }
  }
</script>

<script>
  function validateComment(form) {
    const content = form.querySelector('textarea[name="content"]').value.trim();
    if (!content) {
      if (typeof customAlert === 'function') {
        customAlert('El comentario no puede estar vacío. Por favor, escribe un comentario antes de enviar.', 'Campo Requerido', 'warning');
      } else {
        alert('El comentario no puede estar vacío.');
      }
      return false;
    }
    if (content.length < 10) {
      if (typeof customAlert === 'function') {
        customAlert('El comentario es demasiado corto. Por favor, escribe al menos 10 caracteres para proporcionar retroalimentación útil.', 'Comentario muy corto', 'warning');
      } else {
        alert('El comentario es demasiado corto. Por favor, escribe al menos 10 caracteres.');
      }
      return false;
    }
    return true;
  }
</script>
