{% comment %}Include que renderiza una lista de empresas llamada `empresas` y usa `user` en contexto.{% endcomment %}
{% if empresas and empresas.count > 0 %}
  <div class="space-y-3">
    {% for e in empresas %}
      <div class="p-5 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 hover:border-slate-300 transition-all">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <a href="{% url 'contabilidad:company_detail' e.id %}" class="text-lg font-bold text-blue-600 hover:text-blue-800 transition-colors">{{ e.nombre }}</a>
            <div class="flex items-center space-x-4 mt-2 text-sm text-slate-600">
              <div class="flex items-center space-x-1">
                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span>
                  {% if e.original and e.original.owner %}
                    {{ e.original.owner.get_full_name|default:e.original.owner.username }}
                  {% else %}
                    {{ e.owner.get_full_name|default:e.owner.username }}
                  {% endif %}
                </span>
              </div>
              <span class="inline-block px-2 py-0.5 rounded-lg text-xs font-semibold {% if e.is_template %}bg-blue-100 text-blue-700{% else %}bg-slate-200 text-slate-700{% endif %}">
                {% if e.is_template %}Plantilla{% else %}Empresa{% endif %}
              </span>
            </div>
            {% if e.join_code %}
              <div class="mt-3 p-2 bg-blue-50 border-l-4 border-blue-600 rounded">
                <span class="text-xs font-semibold text-blue-700 uppercase tracking-wide">Código:</span>
                <code class="ml-2 text-sm font-mono text-blue-800 font-bold">{{ e.join_code }}</code>
              </div>
            {% endif %}
          </div>
          
          <div class="flex flex-wrap gap-2 ml-4">
            <a href="{% url 'contabilidad:company_detail' e.id %}" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition-colors">Ver</a>
            
            {% if user.is_superuser or is_docente and e.owner == user %}
              <a href="{% url 'contabilidad:generate_join_code' e.id %}" class="px-3 py-1.5 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm font-semibold transition-colors">Generar Código</a>
            {% endif %}

            {% if e.owner == user and not is_docente %}
              <button
                type="button"
                class="visibility-toggle-btn px-3 py-1.5 rounded-lg text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 transition-colors"
                data-empresa-id="{{ e.id }}"
                aria-pressed="{% if e.visible_to_supervisor %}true{% else %}false{% endif %}"
                title="{% if e.visible_to_supervisor %}Visible a tu docente. Pulsa para ocultar.{% else %}No visible a tu docente. Pulsa para mostrar.{% endif %}"
                data-visible="{% if e.visible_to_supervisor %}1{% else %}0{% endif %}">
                {% if e.visible_to_supervisor %}
                  <span class="sr-only">Estado:</span> Visible: Sí
                {% else %}
                  <span class="sr-only">Estado:</span> Visible: No
                {% endif %}
              </button>
              <noscript>
                <form method="post" action="{% url 'contabilidad:toggle_visibility' e.id %}" style="display:inline">
                  {% csrf_token %}
                  <button type="submit" class="px-3 py-1.5 {% if e.visible_to_supervisor %}bg-emerald-500{% else %}bg-slate-300{% endif %} text-white rounded-lg text-sm font-semibold">Visible: {% if e.visible_to_supervisor %}Sí{% else %}No{% endif %}</button>
                </form>
              </noscript>
              <a href="{% url 'contabilidad:delete_company' e.id %}" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition-colors">Eliminar</a>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <script id="contabilidad-visibility-js">
  ;(function(){
    if (typeof document === 'undefined') return;
    if (document.getElementById('contabilidad-visibility-initialized')) return;
    document.getElementById('contabilidad-visibility-initialized') || document.body.insertAdjacentHTML('beforeend','<div id="contabilidad-visibility-initialized" style="display:none"></div>');

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const apiTemplate = "{% url 'contabilidad:toggle_visibility_api' 0 %}";

    function setButtonState(btn, visible) {
      btn.setAttribute('aria-pressed', visible ? 'true' : 'false');
      btn.dataset.visible = visible ? '1' : '0';
      if (visible) {
        btn.classList.remove('bg-slate-300','text-slate-700');
        btn.classList.add('bg-emerald-600','text-white');
        btn.title = 'Visible a tu docente. Pulsa para ocultar.';
        btn.innerHTML = '<span class="sr-only">Estado:</span> Visible: Sí';
      } else {
        btn.classList.remove('bg-emerald-600','text-white');
        btn.classList.add('bg-slate-300','text-slate-700');
        btn.title = 'No visible a tu docente. Pulsa para mostrar.';
        btn.innerHTML = '<span class="sr-only">Estado:</span> Visible: No';
      }
    }

    document.querySelectorAll('.visibility-toggle-btn').forEach(function(btn){
      const visible = btn.dataset.visible === '1';
      setButtonState(btn, visible);
    });

    if (!document.getElementById('contabilidad-aria-live')) {
      const live = document.createElement('div');
      live.id = 'contabilidad-aria-live';
      live.setAttribute('aria-live','polite');
      live.setAttribute('aria-atomic','true');
      live.style.position = 'absolute';
      live.style.left = '-9999px';
      document.body.appendChild(live);
    }

    document.addEventListener('click', function(evt){
      const btn = evt.target.closest && evt.target.closest('.visibility-toggle-btn');
      if (!btn) return;
      evt.preventDefault();
      const empresaId = btn.dataset.empresaId;
      if (!empresaId) return;

      const url = apiTemplate.replace('/0/', '/' + empresaId + '/');
      const csrftoken = getCookie('csrftoken');

      btn.disabled = true;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({})
      }).then(function(resp){
        if (!resp.ok) throw resp;
        return resp.json();
      }).then(function(data){
        const visible = !!data.visible;
        setButtonState(btn, visible);
        document.getElementById('contabilidad-aria-live').textContent = data.message || (visible ? 'Visibilidad habilitada' : 'Visibilidad deshabilitada');
      }).catch(function(err){
        console.error('Toggle visibility failed', err);
        document.getElementById('contabilidad-aria-live').textContent = 'No se pudo actualizar la visibilidad.';
      }).finally(function(){
        btn.disabled = false;
      });
    });
  })();
  </script>
{% else %}
  <div class="text-center py-12">
    <div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
      </svg>
    </div>
    <p class="text-slate-600 font-medium">No tienes empresas todavía</p>
    <p class="text-sm text-slate-500 mt-1">Crea tu primera empresa o importa una plantilla</p>
  </div>
{% endif %} 
