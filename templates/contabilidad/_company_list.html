{% comment %}Include que renderiza una lista de empresas llamada `empresas` y usa `user` en contexto.{% endcomment %}
{% if empresas and empresas.count > 0 %}
  <div class="space-y-4">
    {% for e in empresas %}
      <div class="bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-blue-400 dark:hover:border-blue-600 hover:shadow-lg transition-all duration-200 overflow-hidden">
        <div class="p-6">
          <div class="flex gap-6">
            <!-- Logo Section - Más grande y prominente -->
            <div class="flex-shrink-0">
              {% if e.logo %}
                <img src="{{ e.logo.url }}" alt="Logo {{ e.nombre }}" class="w-32 h-32 object-cover rounded-xl border-2 border-slate-300 dark:border-slate-600 shadow-lg">
              {% else %}
                <div class="w-32 h-32 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-xl flex items-center justify-center text-white font-bold text-4xl shadow-lg">
                  {{ e.nombre|slice:":2"|upper }}
                </div>
              {% endif %}
            </div>

            <!-- Content Section - Información reorganizada -->
            <div class="flex-1 min-w-0">
              <!-- Header: Nombre y Badge -->
              <div class="flex items-start justify-between gap-3 mb-3">
                <div class="flex-1 min-w-0">
                  <a href="{% url 'contabilidad:company_detail' e.id %}" class="text-xl font-bold text-slate-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors block truncate">
                    {{ e.nombre }}
                  </a>
                  {% if e.eslogan %}
                    <p class="text-sm text-slate-600 dark:text-slate-400 italic mt-1 line-clamp-2">"{{ e.eslogan }}"</p>
                  {% endif %}
                </div>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex-shrink-0 {% if e.is_template %}bg-gradient-to-r from-blue-500 to-blue-600 text-white{% else %}bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300{% endif %}">
                  {% if e.is_template %}
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
                    </svg>
                    Plantilla
                  {% else %}
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path>
                    </svg>
                    Empresa
                  {% endif %}
                </span>
              </div>

              <!-- Info Row: Owner -->
              <div class="flex items-center gap-2 mb-3">
                <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                  <svg class="w-4 h-4 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <span class="font-medium">
                    {% if e.original and e.original.owner %}
                      {{ e.original.owner.get_full_name|default:e.original.owner.username }}
                    {% else %}
                      {{ e.owner.get_full_name|default:e.owner.username }}
                    {% endif %}
                  </span>
                </div>
              </div>

              <!-- Join Code Section - Con toggle para ocultar/mostrar -->
              {% if e.join_code %}
                <div class="mt-3">
                  <button
                    type="button"
                    onclick="this.nextElementSibling.classList.toggle('hidden')"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 dark:bg-blue-950/50 hover:bg-blue-100 dark:hover:bg-blue-950/70 border border-blue-200 dark:border-blue-800 rounded-lg text-xs font-semibold text-blue-700 dark:text-blue-400 transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <span>Mostrar código de acceso</span>
                  </button>
                  <div class="hidden mt-2 px-3 py-2 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-950/50 dark:to-blue-900/50 border-l-4 border-blue-600 dark:border-blue-500 rounded-lg inline-block">
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-semibold text-blue-700 dark:text-blue-400 uppercase tracking-wide">Código:</span>
                      <code class="text-base font-mono text-blue-900 dark:text-blue-300 font-bold tracking-wider">{{ e.join_code }}</code>
                      <button
                        onclick="navigator.clipboard.writeText('{{ e.join_code }}'); this.innerHTML='<svg class=\'w-4 h-4\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M5 13l4 4L19 7\'></path></svg>'; setTimeout(() => this.innerHTML='<svg class=\'w-4 h-4\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\'></path></svg>', 2000)"
                        title="Copiar código"
                        class="p-1 hover:bg-blue-200 dark:hover:bg-blue-800 rounded transition-colors text-blue-700 dark:text-blue-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Actions Section - Botones en la parte inferior -->
          <div class="mt-5 pt-4 border-t border-slate-200 dark:border-slate-700 flex flex-wrap gap-2">
            <a href="{% url 'contabilidad:company_detail' e.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-all hover:shadow-md">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              Ver Detalles
            </a>

            {% if user.is_superuser or is_docente and e.owner == user %}
              <a href="{% url 'contabilidad:generate_join_code' e.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-600 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white rounded-lg text-sm font-semibold transition-all hover:shadow-md">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Generar Código
              </a>
            {% endif %}

            {% if e.owner == user and not is_docente %}
              <button
                type="button"
                class="visibility-toggle-btn inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all hover:shadow-md"
                data-empresa-id="{{ e.id }}"
                aria-pressed="{% if e.visible_to_supervisor %}true{% else %}false{% endif %}"
                title="{% if e.visible_to_supervisor %}Visible a tu docente. Pulsa para ocultar.{% else %}No visible a tu docente. Pulsa para mostrar.{% endif %}"
                data-visible="{% if e.visible_to_supervisor %}1{% else %}0{% endif %}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                {% if e.visible_to_supervisor %}
                  <span class="sr-only">Estado:</span> Visible: Sí
                {% else %}
                  <span class="sr-only">Estado:</span> Visible: No
                {% endif %}
              </button>
              <noscript>
                <form method="post" action="{% url 'contabilidad:toggle_visibility' e.id %}" style="display:inline">
                  {% csrf_token %}
                  <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 {% if e.visible_to_supervisor %}bg-emerald-600{% else %}bg-slate-400{% endif %} text-white rounded-lg text-sm font-semibold">Visible: {% if e.visible_to_supervisor %}Sí{% else %}No{% endif %}</button>
                </form>
              </noscript>
              <a href="{% url 'contabilidad:delete_company' e.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition-all hover:shadow-md ml-auto">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Eliminar
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <script id="contabilidad-visibility-js">
  ;(function(){
    if (typeof document === 'undefined') return;
    if (document.getElementById('contabilidad-visibility-initialized')) return;
    document.getElementById('contabilidad-visibility-initialized') || document.body.insertAdjacentHTML('beforeend','<div id="contabilidad-visibility-initialized" style="display:none"></div>');

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const apiTemplate = "{% url 'contabilidad:toggle_visibility_api' 0 %}";

    function setButtonState(btn, visible) {
      btn.setAttribute('aria-pressed', visible ? 'true' : 'false');
      btn.dataset.visible = visible ? '1' : '0';
      if (visible) {
        btn.classList.remove('bg-slate-400','text-white','hover:bg-slate-500');
        btn.classList.add('bg-emerald-600','text-white','hover:bg-emerald-700');
        btn.title = 'Visible a tu docente. Pulsa para ocultar.';
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg><span class="sr-only">Estado:</span> Visible: Sí';
      } else {
        btn.classList.remove('bg-emerald-600','text-white','hover:bg-emerald-700');
        btn.classList.add('bg-slate-400','text-white','hover:bg-slate-500');
        btn.title = 'No visible a tu docente. Pulsa para mostrar.';
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg><span class="sr-only">Estado:</span> Visible: No';
      }
    }

    document.querySelectorAll('.visibility-toggle-btn').forEach(function(btn){
      const visible = btn.dataset.visible === '1';
      setButtonState(btn, visible);
    });

    if (!document.getElementById('contabilidad-aria-live')) {
      const live = document.createElement('div');
      live.id = 'contabilidad-aria-live';
      live.setAttribute('aria-live','polite');
      live.setAttribute('aria-atomic','true');
      live.style.position = 'absolute';
      live.style.left = '-9999px';
      document.body.appendChild(live);
    }

    document.addEventListener('click', function(evt){
      const btn = evt.target.closest && evt.target.closest('.visibility-toggle-btn');
      if (!btn) return;
      evt.preventDefault();
      const empresaId = btn.dataset.empresaId;
      if (!empresaId) return;

      const url = apiTemplate.replace('/0/', '/' + empresaId + '/');
      const csrftoken = getCookie('csrftoken');

      btn.disabled = true;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({})
      }).then(function(resp){
        if (!resp.ok) throw resp;
        return resp.json();
      }).then(function(data){
        const visible = !!data.visible;
        setButtonState(btn, visible);
        document.getElementById('contabilidad-aria-live').textContent = data.message || (visible ? 'Visibilidad habilitada' : 'Visibilidad deshabilitada');
      }).catch(function(err){
        console.error('Toggle visibility failed', err);
        document.getElementById('contabilidad-aria-live').textContent = 'No se pudo actualizar la visibilidad.';
      }).finally(function(){
        btn.disabled = false;
      });
    });
  })();
  </script>
{% else %}
  <div class="text-center py-12">
    <div class="w-16 h-16 bg-slate-100 rounded-lg flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
      </svg>
    </div>
    <p class="text-slate-600 font-medium">No tienes empresas todavía</p>
    <p class="text-sm text-slate-500 mt-1">Crea tu primera empresa o importa una plantilla</p>
  </div>
{% endif %}
