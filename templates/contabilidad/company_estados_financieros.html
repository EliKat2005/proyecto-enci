{% extends 'base.html' %}
{% load static %}

{% block title %}Estados Financieros - {{ empresa.nombre }}{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-8rem)] bg-gradient-to-br from-slate-50 via-blue-50/30 to-slate-100 dark:from-black dark:via-slate-950 dark:to-slate-900 py-6">
  <div class="mx-auto px-4 xl:px-8 max-w-[1600px]">

  {# Header #}
  {% include 'contabilidad/_company_header_minimal.html' with current_panel='estados' %}

  {# Selector de Reporte y acciones #}
  <div class="mt-4 bg-white dark:bg-slate-900 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800 p-4">
    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-2">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg bg-rose-100 dark:bg-rose-950 text-rose-700 dark:text-rose-400 flex items-center justify-center font-bold text-sm">EF</div>
          <div>
            <h2 class="text-lg font-bold text-slate-900 dark:text-gray-100">Estados Financieros</h2>
            <p class="text-xs text-slate-600 dark:text-slate-300">{{ empresa.nombre }}</p>
          </div>
        </div>
        <div class="flex gap-2">
          <a href="?reporte=balance{% if fecha_str %}&fecha={{ fecha_str }}{% endif %}"
             class="px-3 py-1.5 text-sm rounded-lg font-semibold transition-colors {% if reporte == 'balance' %}bg-rose-600 text-white{% else %}bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600{% endif %}">
            Balance General
          </a>
          <a href="?reporte=resultados{% if fecha_inicio %}&fecha_inicio={{ fecha_inicio|date:'Y-m-d' }}&fecha_fin={{ fecha_fin|date:'Y-m-d' }}{% endif %}"
             class="px-3 py-1.5 text-sm rounded-lg font-semibold transition-colors {% if reporte == 'resultados' %}bg-rose-600 text-white{% else %}bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600{% endif %}">
            Estado de Resultados
          </a>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 justify-end">
        <button onclick="window.print()" class="px-3 py-1.5 text-sm bg-slate-700 text-white rounded-lg font-semibold hover:bg-slate-800 transition-colors no-print">Imprimir</button>
      </div>
    </div>

    {# Balance General #}
    {% if reporte == 'balance' and balance_general %}
    <div>
      {# Filtro de fecha #}
      <form method="get" class="flex flex-wrap gap-2 items-end mt-4 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
        <input type="hidden" name="reporte" value="balance">
        <div class="flex-1 min-w-[200px] max-w-xs">
          <label for="fecha" class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Fecha de Corte</label>
          <input type="date" id="fecha" name="fecha" value="{{ fecha_corte|date:'Y-m-d' }}"
                 class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500">
        </div>
        <button type="submit" class="px-4 py-2 text-sm bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 transition-colors">
          Generar
        </button>
      </form>

      {# Encabezado del Reporte #}
      <div class="text-center my-6">
        <h3 class="text-lg font-bold text-slate-900 dark:text-gray-100">{{ empresa.nombre|upper }}</h3>
        <p class="text-base font-semibold text-slate-700 dark:text-slate-200">BALANCE GENERAL</p>
        <p class="text-xs text-slate-600 dark:text-slate-400">Al {{ balance_general.fecha_corte }}</p>
      </div>

      {# ALERTA: Balance descuadrado #}
      {% if balance_general.mensaje_balance %}
      <div class="mb-4 p-4 bg-red-50 dark:bg-red-950/30 border-l-4 border-red-500 dark:border-red-600 rounded-r-lg">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-red-600 dark:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="flex-1">
            <h4 class="font-bold text-red-900 dark:text-red-400 mb-1 text-sm">Balance General Descuadrado</h4>
            <p class="text-xs text-red-800 dark:text-red-300 mb-2">
              {{ balance_general.mensaje_balance }}
            </p>
            <div class="text-xs text-red-700 dark:text-red-400 space-y-1">
              <p><strong>Posibles causas:</strong></p>
              <ul class="list-disc list-inside ml-2 space-y-0.5">
                <li>Asientos contables sin cuadrar (Debe ≠ Haber)</li>
                <li>Errores en clasificación de cuentas (Activo/Pasivo/Patrimonio)</li>
                <li>Transacciones con naturaleza incorrecta</li>
              </ul>
              <p class="mt-2"><strong>Recomendación:</strong> Revise el <a href="{% url 'contabilidad:company_balance_comprobacion' empresa.id %}" class="underline font-semibold hover:text-red-900 dark:hover:text-red-200">Balance de Comprobación</a> para identificar cuentas con saldos incorrectos.</p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      {# Contenido del Balance #}
      <div class="grid md:grid-cols-2 gap-4">

        {# Activos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
          <div class="bg-blue-600 dark:bg-blue-700 text-white px-3 py-2 font-bold text-sm">ACTIVOS</div>
          <div class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for item in balance_general.detalle_activos %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300">{{ item.cuenta.codigo }} - {{ item.cuenta.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-gray-100">${{ item.saldo|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
            {% endfor %}
          </div>
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
            <span>TOTAL ACTIVOS</span>
            <span class="font-mono">${{ balance_general.activos|floatformat:2 }}</span>
          </div>
        </div>

        {# Pasivos + Patrimonio #}
        <div class="space-y-6">

          {# Pasivos #}
          <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
            <div class="bg-red-600 dark:bg-red-700 text-white px-3 py-2 font-bold text-sm">PASIVOS</div>
            <div class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
              {% for item in balance_general.detalle_pasivos %}
              <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
                <span class="text-slate-700 dark:text-slate-300">{{ item.cuenta.codigo }} - {{ item.cuenta.descripcion }}</span>
                <span class="font-mono font-semibold dark:text-gray-100">${{ item.saldo|floatformat:2 }}</span>
              </div>
              {% empty %}
              <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
              {% endfor %}
            </div>
            <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
              <span>TOTAL PASIVOS</span>
              <span class="font-mono">${{ balance_general.pasivos|floatformat:2 }}</span>
            </div>
          </div>

          {# Patrimonio #}
          <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
            <div class="bg-green-600 dark:bg-green-700 text-white px-3 py-2 font-bold text-sm">PATRIMONIO</div>
            <div class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
              {% for item in balance_general.detalle_patrimonio %}
              <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
                <span class="text-slate-700 dark:text-slate-300">{{ item.cuenta.codigo }} - {{ item.cuenta.descripcion }}</span>
                <span class="font-mono font-semibold dark:text-gray-100">${{ item.saldo|floatformat:2 }}</span>
              </div>
              {% empty %}
              <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
              {% endfor %}
            </div>
            <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
              <span>TOTAL PATRIMONIO</span>
              <span class="font-mono">${{ balance_general.patrimonio|floatformat:2 }}</span>
            </div>
          </div>

        </div>
      </div>

      {# Ecuación Patrimonial #}
      <div class="mt-6 p-4 bg-slate-800 dark:bg-slate-950 text-white rounded-lg">
        <div class="grid grid-cols-3 gap-3 text-center">
          <div>
            <p class="text-xs opacity-80">Activos</p>
            <p class="text-xl font-bold">${{ balance_general.activos|floatformat:2 }}</p>
          </div>
          <div class="flex items-center justify-center">
            <span class="text-2xl font-bold">=</span>
          </div>
          <div>
            <p class="text-xs opacity-80">Pasivos + Patrimonio</p>
            <p class="text-xl font-bold">${{ balance_general.pasivos|add:balance_general.patrimonio|floatformat:2 }}</p>
          </div>
        </div>
        <div class="mt-3 text-center">
          {% if balance_general.balanceado %}
            <p class="text-green-300 dark:text-green-400 font-semibold text-sm">✓ Balance Cuadrado</p>
          {% else %}
            <p class="text-red-300 dark:text-red-400 font-semibold text-sm">⚠ Diferencia: ${{ balance_general.diferencia|floatformat:2 }}</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    {# Estado de Resultados #}
    {% if reporte == 'resultados' and estado_resultados %}
    <div>
      {# Filtro de fechas #}
      <form method="get" class="flex flex-wrap gap-2 items-end mt-4 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700">
        <input type="hidden" name="reporte" value="resultados">
        <div class="flex-1 min-w-[200px]">
          <label for="fecha_inicio" class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Fecha Inicio</label>
          <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio|date:'Y-m-d' }}"
                 class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500">
        </div>
        <div class="flex-1 min-w-[200px]">
          <label for="fecha_fin" class="block text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Fecha Fin</label>
          <input type="date" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin|date:'Y-m-d' }}"
                 class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-700 dark:bg-slate-800 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500">
        </div>
        <button type="submit" class="px-4 py-2 text-sm bg-rose-600 text-white rounded-lg font-semibold hover:bg-rose-700 transition-colors">
          Generar
        </button>
      </form>

      {# Encabezado del Reporte #}
      <div class="text-center my-6">
        <h3 class="text-lg font-bold text-slate-900 dark:text-gray-100">{{ empresa.nombre|upper }}</h3>
        <p class="text-base font-semibold text-slate-700 dark:text-slate-200">ESTADO DE RESULTADOS</p>
        <p class="text-xs text-slate-600 dark:text-slate-400">{{ estado_resultados.periodo }}</p>
      </div>

      {# Contenido del Estado #}
      <div class="max-w-3xl mx-auto">

        {# Mensaje informativo si no hay cuentas de resultado #}
        {% if estado_resultados.ingresos == 0 and estado_resultados.costos == 0 and estado_resultados.gastos == 0 %}
        <div class="mb-4 p-4 bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-lg">
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-amber-600 dark:text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
              <h4 class="font-bold text-amber-900 dark:text-amber-400 mb-1 text-sm">No hay cuentas de resultado configuradas</h4>
              <p class="text-xs text-amber-800 dark:text-amber-300 mb-2">
                Para generar el Estado de Resultados, necesitas crear cuentas de tipo <strong>Ingreso</strong>, <strong>Costo</strong> y <strong>Gasto</strong> en el Plan de Cuentas.
              </p>
              <div class="text-xs text-amber-700 dark:text-amber-400 space-y-0.5">
                <p>• <strong>Ejemplo:</strong> 4 - Ingresos → 4.1 - Ventas (transaccional)</p>
                <p>• <strong>Ejemplo:</strong> 5 - Costos → 5.1 - Costo de Ventas (transaccional)</p>
                <p>• <strong>Ejemplo:</strong> 6 - Gastos → 6.1 - Gastos Administrativos (transaccional)</p>
              </div>
              <a href="{% url 'contabilidad:company_plan' empresa.id %}"
                 class="mt-3 inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Ir al Plan de Cuentas
              </a>
            </div>
          </div>
        </div>
        {% endif %}

        {# Ingresos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden mb-3">
          <div class="bg-green-600 dark:bg-green-700 text-white px-3 py-2 font-bold text-sm">INGRESOS</div>
          <div class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for item in estado_resultados.detalle_ingresos %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300">{{ item.cuenta.codigo }} - {{ item.cuenta.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-gray-100">${{ item.monto|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin ingresos registrados</div>
            {% endfor %}
          </div>
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
            <span>TOTAL INGRESOS</span>
            <span class="font-mono">${{ estado_resultados.ingresos|floatformat:2 }}</span>
          </div>
        </div>

        {# Costos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden mb-3">
          <div class="bg-orange-600 dark:bg-orange-700 text-white px-3 py-2 font-bold text-sm">COSTOS DE VENTAS</div>
          <div class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for item in estado_resultados.detalle_costos %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300">{{ item.cuenta.codigo }} - {{ item.cuenta.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-gray-100">${{ item.monto|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin costos registrados</div>
            {% endfor %}
          </div>
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
            <span>TOTAL COSTOS</span>
            <span class="font-mono">-${{ estado_resultados.costos|floatformat:2 }}</span>
          </div>
        </div>

        {# Utilidad Bruta #}
        <div class="px-3 py-2 flex justify-between font-bold bg-blue-100 dark:bg-blue-950/50 rounded-lg mb-3 text-sm dark:text-gray-100">
          <span>UTILIDAD BRUTA</span>
          <span class="font-mono {% if estado_resultados.utilidad_bruta >= 0 %}text-green-700 dark:text-green-400{% else %}text-red-700 dark:text-red-400{% endif %}">
            ${{ estado_resultados.utilidad_bruta|floatformat:2 }}
          </span>
        </div>

        {# Gastos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden mb-3">
          <div class="bg-red-600 dark:bg-red-700 text-white px-3 py-2 font-bold text-sm">GASTOS OPERACIONALES</div>
          <div class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for item in estado_resultados.detalle_gastos %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300">{{ item.cuenta.codigo }} - {{ item.cuenta.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-gray-100">${{ item.monto|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin gastos registrados</div>
            {% endfor %}
          </div>
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
            <span>TOTAL GASTOS</span>
            <span class="font-mono">-${{ estado_resultados.gastos|floatformat:2 }}</span>
          </div>
        </div>

        {# Utilidad Neta #}
        <div class="p-4 flex justify-between font-bold bg-slate-800 dark:bg-slate-950 text-white rounded-lg text-base">
          <span>UTILIDAD NETA</span>
          <span class="font-mono {% if estado_resultados.utilidad_neta >= 0 %}text-green-300 dark:text-green-400{% else %}text-red-300 dark:text-red-400{% endif %}">
            ${{ estado_resultados.utilidad_neta|floatformat:2 }}
          </span>
        </div>

        {# Resumen #}
        <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg text-xs">
          <p class="text-slate-600 dark:text-slate-300 mb-1.5">
            <strong>Margen Bruto:</strong>
            {% if estado_resultados.ingresos > 0 %}
              {{ estado_resultados.utilidad_bruta|floatformat:2 }} / {{ estado_resultados.ingresos|floatformat:2 }} =
              {% widthratio estado_resultados.utilidad_bruta estado_resultados.ingresos 100 %}%
            {% else %}
              N/A
            {% endif %}
          </p>
          <p class="text-slate-600 dark:text-slate-300">
            <strong>Margen Neto:</strong>
            {% if estado_resultados.ingresos > 0 %}
              {{ estado_resultados.utilidad_neta|floatformat:2 }} / {{ estado_resultados.ingresos|floatformat:2 }} =
              {% widthratio estado_resultados.utilidad_neta estado_resultados.ingresos 100 %}%
            {% else %}
              N/A
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Comentarios del Docente - Componente Unificado -->
    {% include 'contabilidad/_comments_section.html' with section_code='EF' %}

  </div>

</div>

<style>
@media print {
  .no-print {
    display: none !important;
  }
  body {
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
  }
}
</style>
{% endblock %}
