{% extends 'base.html' %}
{% load static %}
{% load financial_filters %}

{% block title %}Estados Financieros - {{ empresa.nombre }}{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-8rem)] bg-gradient-to-br from-slate-50 via-blue-50/30 to-slate-100 dark:from-black dark:via-slate-950 dark:to-slate-900 py-6">
  <div class="mx-auto px-4 xl:px-8 max-w-[1600px]">

  {# Header #}
  {% include 'contabilidad/_company_header_minimal.html' with current_panel='estados' %}

  {# Selector de Reporte y acciones #}
  <div class="mt-4 bg-white dark:bg-slate-900 rounded-lg shadow-sm border border-slate-200 dark:border-slate-800 p-4">
    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-2">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg bg-rose-100 dark:bg-rose-950 text-rose-700 dark:text-rose-400 flex items-center justify-center font-bold text-sm">EF</div>
          <div>
            <h2 class="text-lg font-bold text-slate-900 dark:text-slate-100">Estados Financieros</h2>
            <p class="text-xs text-slate-600 dark:text-slate-300">{{ empresa.nombre }}</p>
          </div>
        </div>
        <div class="flex gap-2">
          <a href="?reporte=balance{% if fecha_str %}&fecha={{ fecha_str }}{% endif %}"
             class="px-3 py-1.5 text-sm rounded-lg font-semibold transition-colors {% if reporte == 'balance' %}bg-rose-600 text-white{% else %}bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600{% endif %}">
            Balance General
          </a>
          <a href="?reporte=resultados{% if fecha_inicio %}&fecha_inicio={{ fecha_inicio|date:'Y-m-d' }}&fecha_fin={{ fecha_fin|date:'Y-m-d' }}{% endif %}"
             class="px-3 py-1.5 text-sm rounded-lg font-semibold transition-colors {% if reporte == 'resultados' %}bg-rose-600 text-white{% else %}bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600{% endif %}">
            Estado de Resultados
          </a>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 justify-end">
        <button onclick="window.print()" class="px-3 py-1.5 text-sm bg-slate-700 text-white rounded-lg font-semibold hover:bg-slate-800 transition-colors no-print">Imprimir</button>
      </div>
    </div>

    {# Balance General #}
    {% if reporte == 'balance' and balance_general %}
    <div>
      {# Encabezado del Reporte #}
      <div class="text-center my-6">
        <h3 class="text-lg font-bold text-slate-900 dark:text-gray-100">{{ empresa.nombre|upper }}</h3>
        <p class="text-base font-semibold text-slate-700 dark:text-slate-200">BALANCE GENERAL</p>
        <p class="text-xs text-slate-600 dark:text-slate-400">Al {{ balance_general.fecha_corte }}</p>
      </div>

      {# ALERTA: Balance descuadrado #}
      {% if balance_general.mensaje_balance %}
      <div class="mb-4 p-4 bg-red-50 dark:bg-red-950/30 border-l-4 border-red-500 dark:border-red-600 rounded-r-lg">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-red-600 dark:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div class="flex-1">
            <h4 class="font-bold text-red-900 dark:text-red-400 mb-1 text-sm">Balance General Descuadrado</h4>
            <p class="text-xs text-red-800 dark:text-red-300 mb-2">
              {{ balance_general.mensaje_balance }}
            </p>
            <div class="text-xs text-red-700 dark:text-red-400 space-y-1">
              <p><strong>Posibles causas:</strong></p>
              <ul class="list-disc list-inside ml-2 space-y-0.5">
                <li>Asientos contables sin cuadrar (Debe ‚â† Haber)</li>
                <li>Errores en clasificaci√≥n de cuentas (Activo/Pasivo/Patrimonio)</li>
                <li>Transacciones con naturaleza incorrecta</li>
              </ul>
              <p class="mt-2"><strong>Recomendaci√≥n:</strong> Revise el <a href="{% url 'contabilidad:company_balance_comprobacion' empresa.id %}" class="underline font-semibold hover:text-red-900 dark:hover:text-red-200">Balance de Comprobaci√≥n</a> para identificar cuentas con saldos incorrectos.</p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      {# Contenido del Balance #}
      <div class="grid md:grid-cols-2 gap-4">

        {# Activos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
          <div class="bg-blue-600 dark:bg-blue-700 text-white px-3 py-2 font-bold text-sm flex items-center justify-between">
            <span>ACTIVOS</span>
            <button type="button" onclick="toggleDetalleSeccion('activos')" class="px-2 py-1 bg-blue-700 dark:bg-blue-800 hover:bg-blue-800 dark:hover:bg-blue-900 rounded text-xs transition-colors">
              <span id="btn-activos">üëÅ Ver detalles</span>
            </button>
          </div>
          
          {# Vista resumida: solo cuentas padre #}
          <div id="activos-resumido" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for grupo in balance_general.activos_agrupados %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300 font-semibold">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-gray-100">${{ grupo.total|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
            {% endfor %}
          </div>
          
          {# Vista detallada: con cuentas hijas #}
          <div id="activos-detallado" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900 hidden">
            {% for grupo in balance_general.activos_agrupados %}
            <div class="bg-slate-50 dark:bg-slate-800/50">
              <div class="px-3 py-1.5 flex justify-between text-sm font-semibold">
                <span class="text-slate-800 dark:text-slate-200">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                <span class="font-mono text-slate-800 dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
              </div>
              {% for hija in grupo.cuentas_hijas %}
              <div class="px-6 py-1 flex justify-between text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
                <span class="text-slate-600 dark:text-slate-400 text-xs">{{ hija.cuenta.codigo }} ‚Äî {{ hija.cuenta.descripcion }}</span>
                <span class="font-mono text-slate-600 dark:text-slate-300 text-xs">${{ hija.monto|floatformat:2 }}</span>
              </div>
              {% endfor %}
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
            {% endfor %}
          </div>
          
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
            <span>TOTAL ACTIVOS</span>
            <span class="font-mono">${{ balance_general.activos|floatformat:2 }}</span>
          </div>
        </div>

        {# Pasivos + Patrimonio #}
        <div class="space-y-6">

          {# Pasivos #}
          <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
            <div class="bg-red-600 dark:bg-red-700 text-white px-3 py-2 font-bold text-sm flex items-center justify-between">
              <span>PASIVOS</span>
              <button type="button" onclick="toggleDetalleSeccion('pasivos')" class="px-2 py-1 bg-red-700 dark:bg-red-800 hover:bg-red-800 dark:hover:bg-red-900 rounded text-xs transition-colors">
                <span id="btn-pasivos">üëÅ Ver detalles</span>
              </button>
            </div>
            
            {# Vista resumida #}
            <div id="pasivos-resumido" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
              {% for grupo in balance_general.pasivos_agrupados %}
              <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
                <span class="text-slate-700 dark:text-slate-300 font-semibold">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                <span class="font-mono font-semibold dark:text-gray-100">${{ grupo.total|floatformat:2 }}</span>
              </div>
              {% empty %}
              <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
              {% endfor %}
            </div>
            
            {# Vista detallada #}
            <div id="pasivos-detallado" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900 hidden">
              {% for grupo in balance_general.pasivos_agrupados %}
              <div class="bg-slate-50 dark:bg-slate-800/50">
                <div class="px-3 py-1.5 flex justify-between text-sm font-semibold">
                  <span class="text-slate-800 dark:text-slate-200">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                  <span class="font-mono text-slate-800 dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
                </div>
                {% for hija in grupo.cuentas_hijas %}
                <div class="px-6 py-1 flex justify-between text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
                  <span class="text-slate-600 dark:text-slate-400 text-xs">{{ hija.cuenta.codigo }} ‚Äî {{ hija.cuenta.descripcion }}</span>
                  <span class="font-mono text-slate-600 dark:text-slate-300 text-xs">${{ hija.monto|floatformat:2 }}</span>
                </div>
                {% endfor %}
              </div>
              {% empty %}
              <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
              {% endfor %}
            </div>
            
            <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
              <span>TOTAL PASIVOS</span>
              <span class="font-mono">${{ balance_general.pasivos|floatformat:2 }}</span>
            </div>
          </div>

          {# Patrimonio #}
          <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
            <div class="bg-green-600 dark:bg-green-700 text-white px-3 py-2 font-bold text-sm flex items-center justify-between">
              <span>PATRIMONIO</span>
              <button type="button" onclick="toggleDetalleSeccion('patrimonio')" class="px-2 py-1 bg-green-700 dark:bg-green-800 hover:bg-green-800 dark:hover:bg-green-900 rounded text-xs transition-colors">
                <span id="btn-patrimonio">üëÅ Ver detalles</span>
              </button>
            </div>
            
            {# Vista resumida #}
            <div id="patrimonio-resumido" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
              {% for grupo in balance_general.patrimonio_agrupados %}
              <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
                <span class="text-slate-700 dark:text-slate-300 font-semibold">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                <span class="font-mono font-semibold dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
              </div>
              {% empty %}
              <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
              {% endfor %}
            </div>
            
            {# Vista detallada #}
            <div id="patrimonio-detallado" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900 hidden">
              {% for grupo in balance_general.patrimonio_agrupados %}
              <div class="bg-slate-50 dark:bg-slate-800/50">
                <div class="px-3 py-1.5 flex justify-between text-sm font-semibold">
                  <span class="text-slate-800 dark:text-slate-200">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                  <span class="font-mono text-slate-800 dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
                </div>
                {% for hija in grupo.cuentas_hijas %}
                <div class="px-6 py-1 flex justify-between text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
                  <span class="text-slate-600 dark:text-slate-400 text-xs">{{ hija.cuenta.codigo }} ‚Äî {{ hija.cuenta.descripcion }}</span>
                  <span class="font-mono text-slate-600 dark:text-slate-300 text-xs">${{ hija.monto|floatformat:2 }}</span>
                </div>
                {% endfor %}
              </div>
              {% empty %}
              <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin movimientos</div>
              {% endfor %}
            </div>
            
            <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-slate-100">
              <span>TOTAL PATRIMONIO</span>
              <span class="font-mono">${{ balance_general.patrimonio|floatformat:2 }}</span>
            </div>
          </div>

        </div>
      </div>

      {# Ecuaci√≥n Patrimonial #}
      <div class="mt-6 p-4 bg-slate-800 dark:bg-slate-950 text-white rounded-lg">
        <div class="grid grid-cols-3 gap-3 text-center">
          <div>
            <p class="text-xs opacity-80">Activos</p>
            <p class="text-xl font-bold">${{ balance_general.activos|floatformat:2 }}</p>
          </div>
          <div class="flex items-center justify-center">
            <span class="text-2xl font-bold">=</span>
          </div>
          <div>
            <p class="text-xs opacity-80">Pasivos + Patrimonio</p>
            <p class="text-xl font-bold">${{ balance_general.pasivos_mas_patrimonio|floatformat:2 }}</p>
          </div>
        </div>
        <div class="mt-3 text-center">
          {% if balance_general.balanceado %}
            <p class="text-green-300 dark:text-green-400 font-semibold text-sm">‚úì Balance Cuadrado</p>
          {% else %}
            <p class="text-red-300 dark:text-red-400 font-semibold text-sm">‚ö† Diferencia: ${{ balance_general.diferencia|floatformat:2 }}</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    {# Estado de Resultados #}
    {% if reporte == 'resultados' and estado_resultados %}
    <div>
      {# Encabezado del Reporte #}
      <div class="text-center my-6">
        <h3 class="text-lg font-bold text-slate-900 dark:text-gray-100">{{ empresa.nombre|upper }}</h3>
        <p class="text-base font-semibold text-slate-700 dark:text-slate-200">ESTADO DE RESULTADOS</p>
        <p class="text-xs text-slate-600 dark:text-slate-400">{{ estado_resultados.periodo }}</p>
      </div>

      {# Contenido del Estado #}
      <div class="max-w-3xl mx-auto">

        {# Mensaje informativo si no hay cuentas de resultado #}
        {% if estado_resultados.ingresos == 0 and estado_resultados.costos == 0 and estado_resultados.gastos == 0 %}
        <div class="mb-4 p-4 bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-lg">
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-amber-600 dark:text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
              <h4 class="font-bold text-amber-900 dark:text-amber-400 mb-1 text-sm">No hay cuentas de resultado configuradas</h4>
              <p class="text-xs text-amber-800 dark:text-amber-300 mb-2">
                Para generar el Estado de Resultados, necesitas crear cuentas de tipo <strong>Ingreso</strong>, <strong>Costo</strong> y <strong>Gasto</strong> en el Plan de Cuentas.
              </p>
              <div class="text-xs text-amber-700 dark:text-amber-400 space-y-0.5">
                <p>‚Ä¢ <strong>Ejemplo:</strong> 4 - Ingresos ‚Üí 4.1 - Ventas (transaccional)</p>
                <p>‚Ä¢ <strong>Ejemplo:</strong> 5 - Costos ‚Üí 5.1 - Costo de Ventas (transaccional)</p>
                <p>‚Ä¢ <strong>Ejemplo:</strong> 6 - Gastos ‚Üí 6.1 - Gastos Administrativos (transaccional)</p>
              </div>
              <a href="{% url 'contabilidad:company_plan' empresa.id %}"
                 class="mt-3 inline-flex items-center gap-1.5 px-3 py-1.5 text-xs bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Ir al Plan de Cuentas
              </a>
            </div>
          </div>
        </div>
        {% endif %}

        {# Ingresos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden mb-3">
          <div class="bg-green-600 dark:bg-green-700 text-white px-3 py-2 font-bold text-sm flex items-center justify-between">
            <span>INGRESOS</span>
            <button type="button" onclick="toggleDetalleSeccion('ingresos')" class="px-2 py-1 bg-green-700 dark:bg-green-800 hover:bg-green-800 dark:hover:bg-green-900 rounded text-xs transition-colors">
              <span id="btn-ingresos">üëÅ Ver detalles</span>
            </button>
          </div>
          
          {# Vista resumida #}
          <div id="ingresos-resumido" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for grupo in estado_resultados.ingresos_agrupados %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300 font-semibold">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-gray-100">${{ grupo.total|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin ingresos registrados</div>
            {% endfor %}
          </div>
          
          {# Vista detallada #}
          <div id="ingresos-detallado" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900 hidden">
            {% for grupo in estado_resultados.ingresos_agrupados %}
            <div class="bg-slate-50 dark:bg-slate-800/50">
              <div class="px-3 py-1.5 flex justify-between text-sm font-semibold">
                <span class="text-slate-800 dark:text-slate-200">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                <span class="font-mono text-slate-800 dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
              </div>
              {% for hija in grupo.cuentas_hijas %}
              <div class="px-6 py-1 flex justify-between text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
                <span class="text-slate-600 dark:text-slate-400 text-xs">{{ hija.cuenta.codigo }} ‚Äî {{ hija.cuenta.descripcion }}</span>
                <span class="font-mono text-slate-600 dark:text-slate-300 text-xs">${{ hija.monto|floatformat:2 }}</span>
              </div>
              {% endfor %}
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin ingresos registrados</div>
            {% endfor %}
          </div>
          
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
            <span>TOTAL INGRESOS</span>
            <span class="font-mono">${{ estado_resultados.ingresos|floatformat:2 }}</span>
          </div>
        </div>

        {# Costos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden mb-3">
          <div class="bg-orange-600 dark:bg-orange-700 text-white px-3 py-2 font-bold text-sm flex items-center justify-between">
            <span>COSTOS DE VENTAS</span>
            <button type="button" onclick="toggleDetalleSeccion('costos')" class="px-2 py-1 bg-orange-700 dark:bg-orange-800 hover:bg-orange-800 dark:hover:bg-orange-900 rounded text-xs transition-colors">
              <span id="btn-costos">üëÅ Ver detalles</span>
            </button>
          </div>
          
          {# Vista resumida #}
          <div id="costos-resumido" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for grupo in estado_resultados.costos_agrupados %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300 font-semibold">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin costos registrados</div>
            {% endfor %}
          </div>
          
          {# Vista detallada #}
          <div id="costos-detallado" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900 hidden">
            {% for grupo in estado_resultados.costos_agrupados %}
            <div class="bg-slate-50 dark:bg-slate-800/50">
              <div class="px-3 py-1.5 flex justify-between text-sm font-semibold">
                <span class="text-slate-800 dark:text-slate-200">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                <span class="font-mono text-slate-800 dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
              </div>
              {% for hija in grupo.cuentas_hijas %}
              <div class="px-6 py-1 flex justify-between text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
                <span class="text-slate-600 dark:text-slate-400 text-xs">{{ hija.cuenta.codigo }} ‚Äî {{ hija.cuenta.descripcion }}</span>
                <span class="font-mono text-slate-600 dark:text-slate-300 text-xs">${{ hija.monto|floatformat:2 }}</span>
              </div>
              {% endfor %}
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin costos registrados</div>
            {% endfor %}
          </div>
          
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-gray-100">
            <span>TOTAL COSTOS</span>
            <span class="font-mono">-${{ estado_resultados.costos|floatformat:2 }}</span>
          </div>
        </div>

        {# Utilidad Bruta #}
        <div class="px-3 py-2 flex justify-between font-bold bg-blue-100 dark:bg-blue-950/50 rounded-lg mb-3 text-sm dark:text-slate-100">
          <span>UTILIDAD BRUTA</span>
          <span class="font-mono {% if estado_resultados.utilidad_bruta >= 0 %}text-green-700 dark:text-green-400{% else %}text-red-700 dark:text-red-400{% endif %}">
            ${{ estado_resultados.utilidad_bruta|floatformat:2 }}
          </span>
        </div>

        {# Gastos #}
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden mb-3">
          <div class="bg-red-600 dark:bg-red-700 text-white px-3 py-2 font-bold text-sm flex items-center justify-between">
            <span>GASTOS OPERACIONALES</span>
            <button type="button" onclick="toggleDetalleSeccion('gastos')" class="px-2 py-1 bg-red-700 dark:bg-red-800 hover:bg-red-800 dark:hover:bg-red-900 rounded text-xs transition-colors">
              <span id="btn-gastos">üëÅ Ver detalles</span>
            </button>
          </div>
          
          {# Vista resumida #}
          <div id="gastos-resumido" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900">
            {% for grupo in estado_resultados.gastos_agrupados %}
            <div class="px-3 py-1.5 flex justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 text-sm">
              <span class="text-slate-700 dark:text-slate-300 font-semibold">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
              <span class="font-mono font-semibold dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin gastos registrados</div>
            {% endfor %}
          </div>
          
          {# Vista detallada #}
          <div id="gastos-detallado" class="divide-y divide-slate-200 dark:divide-slate-800 dark:bg-slate-900 hidden">
            {% for grupo in estado_resultados.gastos_agrupados %}
            <div class="bg-slate-50 dark:bg-slate-800/50">
              <div class="px-3 py-1.5 flex justify-between text-sm font-semibold">
                <span class="text-slate-800 dark:text-slate-200">{{ grupo.cuenta_padre.codigo }} ‚Äî {{ grupo.cuenta_padre.descripcion }}</span>
                <span class="font-mono text-slate-800 dark:text-slate-100">${{ grupo.total|floatformat:2 }}</span>
              </div>
              {% for hija in grupo.cuentas_hijas %}
              <div class="px-6 py-1 flex justify-between text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
                <span class="text-slate-600 dark:text-slate-400 text-xs">{{ hija.cuenta.codigo }} ‚Äî {{ hija.cuenta.descripcion }}</span>
                <span class="font-mono text-slate-600 dark:text-slate-300 text-xs">${{ hija.monto|floatformat:2 }}</span>
              </div>
              {% endfor %}
            </div>
            {% empty %}
            <div class="px-3 py-3 text-center text-slate-500 dark:text-slate-400 text-xs">Sin gastos registrados</div>
            {% endfor %}
          </div>
          
          <div class="bg-slate-100 dark:bg-slate-800 px-3 py-2 flex justify-between font-bold border-t-2 border-slate-300 dark:border-slate-700 text-sm dark:text-slate-100">
            <span>TOTAL GASTOS</span>
            <span class="font-mono">-${{ estado_resultados.gastos|floatformat:2 }}</span>
          </div>
        </div>

        {# Utilidad Antes de Impuestos #}
        <div class="p-4 flex justify-between font-bold bg-slate-800 dark:bg-slate-950 text-white rounded-lg text-base">
          <span>UTILIDAD ANTES DE IMPUESTOS</span>
          <span class="font-mono {% if estado_resultados.utilidad_neta >= 0 %}text-green-300 dark:text-green-400{% else %}text-red-300 dark:text-red-400{% endif %}">
            ${{ estado_resultados.utilidad_neta|floatformat:2 }}
          </span>
        </div>

        {# C√°lculo de Impuestos y Utilidad del Ejercicio #}
        {% if estado_resultados.utilidad_neta > 0 %}
        <div class="border-t border-slate-200 dark:border-slate-700 pt-4 space-y-3">
          {# 25% Impuesto a la Renta (Sociedad An√≥nima) #}
          <div class="flex justify-between text-sm px-4">
            <span class="text-slate-700 dark:text-slate-300">(-) 25% Impuesto a la Renta</span>
            <span class="font-mono text-red-600 dark:text-red-400">-${{ estado_resultados.impuesto_renta|floatformat:2 }}</span>
          </div>
          
          {# Utilidad del Ejercicio #}
          <div class="p-4 flex justify-between font-bold bg-green-700 dark:bg-green-900 text-white rounded-lg text-base mt-2">
            <span>UTILIDAD DEL EJERCICIO</span>
            <span class="font-mono text-green-100 dark:text-green-200">
              ${{ estado_resultados.utilidad_ejercicio|floatformat:2 }}
            </span>
          </div>
        </div>
        {% elif estado_resultados.utilidad_neta < 0 %}
        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
          <div class="p-4 flex justify-between font-bold bg-red-700 dark:bg-red-900 text-white rounded-lg text-base">
            <span>P√âRDIDA DEL EJERCICIO</span>
            <span class="font-mono text-red-100 dark:text-red-200">
              ${{ estado_resultados.utilidad_neta|floatformat:2 }}
            </span>
          </div>
        </div>
        {% endif %}

        {# Resumen #}
        <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg text-xs">
          <p class="text-slate-600 dark:text-slate-300 mb-1.5">
            <strong>Margen Bruto:</strong>
            {% if estado_resultados.ingresos > 0 %}
              {{ estado_resultados.utilidad_bruta|floatformat:2 }} / {{ estado_resultados.ingresos|floatformat:2 }} =
              {% widthratio estado_resultados.utilidad_bruta estado_resultados.ingresos 100 %}%
            {% else %}
              N/A
            {% endif %}
          </p>
          <p class="text-slate-600 dark:text-slate-300">
            <strong>Margen Neto:</strong>
            {% if estado_resultados.ingresos > 0 %}
              {{ estado_resultados.utilidad_neta|floatformat:2 }} / {{ estado_resultados.ingresos|floatformat:2 }} =
              {% widthratio estado_resultados.utilidad_neta estado_resultados.ingresos 100 %}%
            {% else %}
              N/A
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Comentarios del Docente - Componente Unificado -->
    {% if empresa.visible_to_supervisor %}
      {% include 'contabilidad/_comments_section.html' with comments=comments section_code='EF' section_name='Estados Financieros' %}
    {% endif %}

    <!-- L√≠neas de firma (solo visible al imprimir) -->
    <div class="print-only mt-20 pt-8">
      <div class="flex justify-between items-center px-8">
        <div class="text-center">
          <div class="border-t-2 border-slate-800 dark:border-slate-300 pt-2 px-12">
            <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">Firma Gerente</p>
          </div>
        </div>
        <div class="text-center">
          <div class="border-t-2 border-slate-800 dark:border-slate-300 pt-2 px-12">
            <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">Firma Contador</p>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<style>
/* Ocultar en pantalla, mostrar solo al imprimir */
.print-only {
  display: none;
}

@media print {
  .no-print {
    display: none !important;
  }
  .print-only {
    display: block !important;
  }
  body {
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
  }
}
</style>

<script>
function toggleDetalleSeccion(seccion) {
  const resumido = document.getElementById(`${seccion}-resumido`);
  const detallado = document.getElementById(`${seccion}-detallado`);
  const btn = document.getElementById(`btn-${seccion}`);
  
  if (detallado.classList.contains('hidden')) {
    // Mostrar detalle
    resumido.classList.add('hidden');
    detallado.classList.remove('hidden');
    btn.textContent = 'üëÅ Ocultar detalles';
  } else {
    // Mostrar resumido
    detallado.classList.add('hidden');
    resumido.classList.remove('hidden');
    btn.textContent = 'üëÅ Ver detalles';
  }
}
</script>

<style>
@media print {
  .no-print { display: none !important; }
  body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
}
</style>
{% endblock %}
