# Generated by Django 5.2.8 on 2026-01-17 21:01

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('contabilidad', '0021_alter_plandecuentas_options'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AlterField(
            model_name='empresacomment',
            name='section',
            field=models.CharField(choices=[('PL', 'Plan de Cuentas'), ('DI', 'Libro Diario'), ('MA', 'Libro Mayor'), ('BC', 'Balance de Comprobación'), ('EF', 'Estados Financieros'), ('KD', 'Kardex de Inventario')], max_length=2),
        ),
        migrations.AlterField(
            model_name='empresaplancuenta',
            name='es_auxiliar',
            field=models.BooleanField(default=False, help_text='True si es una cuenta transaccional (hoja) que puede recibir movimientos'),
        ),
        migrations.CreateModel(
            name='ProductoInventario',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('sku', models.CharField(db_index=True, help_text='Código único del producto (SKU)', max_length=50)),
                ('nombre', models.CharField(max_length=200)),
                ('descripcion', models.TextField(blank=True)),
                ('categoria', models.CharField(blank=True, help_text='Categoría del producto (ej: Electrónica, Alimentos, etc.)', max_length=100)),
                ('unidad_medida', models.CharField(help_text='Unidad de medida (unid, kg, litros, cajas, etc.)', max_length=20)),
                ('metodo_valoracion', models.CharField(choices=[('PEPS', 'PEPS (Primero en Entrar, Primero en Salir / FIFO)'), ('UEPS', 'UEPS (Último en Entrar, Primero en Salir / LIFO)'), ('PROMEDIO', 'Promedio Ponderado')], default='PROMEDIO', help_text='Método para calcular el costo de las salidas', max_length=20)),
                ('stock_minimo', models.DecimalField(decimal_places=3, default=0, help_text='Stock mínimo (alerta de reabastecimiento)', max_digits=15)),
                ('stock_maximo', models.DecimalField(blank=True, decimal_places=3, help_text='Stock máximo (opcional)', max_digits=15, null=True)),
                ('activo', models.BooleanField(default=True, help_text='Si es False, el producto está descontinuado')),
                ('fecha_creacion', models.DateTimeField(auto_now_add=True)),
                ('fecha_actualizacion', models.DateTimeField(auto_now=True)),
                ('creado_por', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='productos_creados', to=settings.AUTH_USER_MODEL, db_constraint=False)),
                ('cuenta_costo_venta', models.ForeignKey(blank=True, help_text='Cuenta de Costo de Ventas (tipo Costo, ej: 5.1)', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='productos_costo', to='contabilidad.empresaplancuenta')),
                ('cuenta_inventario', models.ForeignKey(help_text='Cuenta contable de inventario (debe ser tipo Activo, ej: 1.1.04)', on_delete=django.db.models.deletion.PROTECT, related_name='productos', to='contabilidad.empresaplancuenta')),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='productos_inventario', to='contabilidad.empresa')),
            ],
            options={
                'verbose_name': 'Producto (Inventario)',
                'verbose_name_plural': 'Productos (Inventario)',
                'db_table': 'contabilidad_producto_inventario',
                'ordering': ['sku'],
            },
        ),
        migrations.CreateModel(
            name='MovimientoKardex',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('fecha', models.DateField(db_index=True)),
                ('tipo_movimiento', models.CharField(choices=[('ENTRADA', 'Entrada (Compra)'), ('SALIDA', 'Salida (Venta/Consumo)'), ('AJUSTE_ENTRADA', 'Ajuste Positivo (Inventario encontrado)'), ('AJUSTE_SALIDA', 'Ajuste Negativo (Merma/Robo)'), ('DEVOLUCION_COMPRA', 'Devolución de Compra'), ('DEVOLUCION_VENTA', 'Devolución de Venta')], max_length=20)),
                ('cantidad', models.DecimalField(decimal_places=3, help_text='Cantidad de unidades (positivo para entradas, valor absoluto para salidas)', max_digits=15)),
                ('costo_unitario', models.DecimalField(decimal_places=6, help_text='Costo unitario del movimiento (para entradas) o costo asignado (para salidas)', max_digits=15)),
                ('valor_total_movimiento', models.DecimalField(decimal_places=2, help_text='Valor total del movimiento (cantidad * costo_unitario)', max_digits=20)),
                ('cantidad_saldo', models.DecimalField(decimal_places=3, help_text='Stock resultante después del movimiento', max_digits=15)),
                ('costo_promedio', models.DecimalField(decimal_places=6, help_text='Costo promedio ponderado después del movimiento', max_digits=15)),
                ('valor_total_saldo', models.DecimalField(decimal_places=2, help_text='Valor total del inventario después del movimiento (cantidad_saldo * costo_promedio)', max_digits=20)),
                ('documento_referencia', models.CharField(blank=True, help_text='Número de factura, orden de compra, etc.', max_length=100)),
                ('observaciones', models.TextField(blank=True)),
                ('fecha_registro', models.DateTimeField(auto_now_add=True)),
                ('asiento', models.ForeignKey(blank=True, help_text='Asiento contable asociado a este movimiento', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='movimientos_kardex', to='contabilidad.empresaasiento')),
                ('creado_por', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, db_constraint=False)),
                ('tercero', models.ForeignKey(blank=True, help_text='Proveedor (entrada) o cliente (salida)', null=True, on_delete=django.db.models.deletion.SET_NULL, to='contabilidad.empresatercero')),
                ('producto', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='movimientos', to='contabilidad.productoinventario')),
            ],
            options={
                'verbose_name': 'Movimiento Kardex',
                'verbose_name_plural': 'Movimientos Kardex',
                'db_table': 'contabilidad_movimiento_kardex',
                'ordering': ['fecha', 'id'],
            },
        ),
        migrations.CreateModel(
            name='AnomaliaDetectada',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('tipo_anomalia', models.CharField(choices=[('MONTO', 'Monto Inusual'), ('FREQ', 'Frecuencia Anormal'), ('PTRN', 'Patrón Sospechoso'), ('CONT', 'Inconsistencia Contable'), ('TEMP', 'Temporal Atípica')], max_length=5)),
                ('severidad', models.CharField(choices=[('BAJA', 'Baja'), ('MEDIA', 'Media'), ('ALTA', 'Alta'), ('CRITICA', 'Crítica')], default='MEDIA', max_length=7)),
                ('score_anomalia', models.DecimalField(decimal_places=6, help_text='Score del algoritmo (ej: -0.5 en Isolation Forest)', max_digits=10)),
                ('descripcion', models.TextField(help_text='Explicación de por qué es anómala')),
                ('algoritmo_usado', models.CharField(default='IsolationForest', max_length=100)),
                ('fecha_deteccion', models.DateTimeField(auto_now_add=True)),
                ('revisada', models.BooleanField(default=False)),
                ('es_falso_positivo', models.BooleanField(default=False)),
                ('notas_revision', models.TextField(blank=True)),
                ('fecha_revision', models.DateTimeField(blank=True, null=True)),
                ('asiento', models.ForeignKey(blank=True, help_text='Asiento anómalo detectado', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='anomalias', to='contabilidad.empresaasiento')),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='anomalias', to='contabilidad.empresa')),
                ('revisada_por', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='anomalias_revisadas', to=settings.AUTH_USER_MODEL, db_constraint=False)),
                ('transaccion', models.ForeignKey(blank=True, help_text='Transacción anómala detectada', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='anomalias', to='contabilidad.empresatransaccion')),
            ],
            options={
                'verbose_name': 'Anomalía Detectada',
                'verbose_name_plural': 'Anomalías Detectadas',
                'db_table': 'contabilidad_anomalia_detectada',
                'ordering': ['-fecha_deteccion', '-severidad'],
                'indexes': [models.Index(fields=['empresa', '-fecha_deteccion'], name='contabilida_empresa_f17c57_idx'), models.Index(fields=['severidad', 'revisada'], name='contabilida_severid_96b283_idx'), models.Index(fields=['tipo_anomalia'], name='contabilida_tipo_an_75549d_idx')],
            },
        ),
        migrations.CreateModel(
            name='EmpresaCierrePeriodo',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('periodo', models.IntegerField(help_text='Año fiscal cerrado (ej: 2025, 2026)')),
                ('fecha_cierre', models.DateField(help_text='Fecha en la que se ejecutó el cierre (último día del ejercicio)')),
                ('fecha_registro', models.DateTimeField(auto_now_add=True, help_text='Timestamp de cuando se registró el cierre en el sistema')),
                ('utilidad_neta', models.DecimalField(decimal_places=2, default=0, help_text='Utilidad o pérdida del ejercicio (Ingresos - Costos - Gastos)', max_digits=20)),
                ('total_ingresos', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('total_costos', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('total_gastos', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('bloqueado', models.BooleanField(default=True, help_text='Si es True, no se permiten crear/editar asientos en este periodo')),
                ('notas', models.TextField(blank=True, help_text='Observaciones sobre el cierre (opcional)')),
                ('asiento_cierre', models.ForeignKey(blank=True, help_text='Asiento contable que registra el cierre del periodo', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='cierre_generado', to='contabilidad.empresaasiento')),
                ('cerrado_por', models.ForeignKey(help_text='Usuario que ejecutó el cierre', null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, db_constraint=False)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='cierres_periodo', to='contabilidad.empresa')),
            ],
            options={
                'verbose_name': 'Cierre de Periodo',
                'verbose_name_plural': 'Cierres de Periodos',
                'db_table': 'contabilidad_empresa_cierre_periodo',
                'ordering': ['-periodo'],
                'indexes': [models.Index(fields=['empresa', '-periodo'], name='contabilida_empresa_6401b2_idx'), models.Index(fields=['fecha_cierre'], name='contabilida_fecha_c_c6249c_idx')],
                'unique_together': {('empresa', 'periodo')},
            },
        ),
        migrations.CreateModel(
            name='EmpresaCuentaEmbedding',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('embedding_json', models.JSONField(help_text='Representación vectorial de la cuenta (768 dimensiones)')),
                ('modelo_usado', models.CharField(default='sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2', max_length=100)),
                ('dimension', models.IntegerField(default=768)),
                ('fecha_generacion', models.DateTimeField(auto_now_add=True)),
                ('texto_fuente', models.TextField(help_text='Código + Descripción + Tipo usado para generar embedding')),
                ('cuenta', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='embeddings', to='contabilidad.empresaplancuenta')),
            ],
            options={
                'verbose_name': 'Embedding de Cuenta',
                'verbose_name_plural': 'Embeddings de Cuentas',
                'db_table': 'contabilidad_cuenta_embedding',
                'indexes': [models.Index(fields=['cuenta'], name='contabilida_cuenta__2e240c_idx'), models.Index(fields=['-fecha_generacion'], name='contabilida_fecha_g_77019c_idx')],
            },
        ),
        migrations.CreateModel(
            name='EmpresaMetrica',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('fecha_calculo', models.DateTimeField(auto_now_add=True)),
                ('periodo_inicio', models.DateField()),
                ('periodo_fin', models.DateField()),
                ('activo_corriente', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('pasivo_corriente', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('razon_corriente', models.DecimalField(blank=True, decimal_places=4, max_digits=10, null=True)),
                ('prueba_acida', models.DecimalField(blank=True, decimal_places=4, max_digits=10, null=True)),
                ('ingresos_totales', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('gastos_totales', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('utilidad_neta', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('margen_neto', models.DecimalField(blank=True, decimal_places=4, max_digits=10, null=True)),
                ('roe', models.DecimalField(blank=True, decimal_places=4, help_text='Return on Equity', max_digits=10, null=True)),
                ('roa', models.DecimalField(blank=True, decimal_places=4, help_text='Return on Assets', max_digits=10, null=True)),
                ('total_activos', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('total_pasivos', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('total_patrimonio', models.DecimalField(decimal_places=2, default=0, max_digits=20)),
                ('razon_endeudamiento', models.DecimalField(blank=True, decimal_places=4, max_digits=10, null=True)),
                ('num_transacciones', models.IntegerField(default=0)),
                ('num_cuentas_activas', models.IntegerField(default=0)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='metricas', to='contabilidad.empresa')),
            ],
            options={
                'verbose_name': 'Métrica Empresarial',
                'verbose_name_plural': 'Métricas Empresariales',
                'db_table': 'contabilidad_empresa_metrica',
                'ordering': ['-fecha_calculo'],
                'indexes': [models.Index(fields=['empresa', '-fecha_calculo'], name='contabilida_empresa_36a83d_idx'), models.Index(fields=['periodo_inicio', 'periodo_fin'], name='contabilida_periodo_6b6bdb_idx')],
            },
        ),
        migrations.CreateModel(
            name='EmpresaMetricasCache',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('periodo', models.DateField(help_text='Primer día del período (YYYY-MM-01)')),
                ('metricas_json', models.JSONField(help_text='Métricas pre-calculadas en formato JSON')),
                ('fecha_calculo', models.DateTimeField(auto_now=True, help_text='Última actualización')),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='metricas_cache', to='contabilidad.empresa')),
            ],
            options={
                'verbose_name': 'Cache de Métricas',
                'verbose_name_plural': 'Cache de Métricas',
                'db_table': 'contabilidad_empresa_metricas_cache',
                'ordering': ['-periodo'],
                'indexes': [models.Index(fields=['empresa', '-fecha_calculo'], name='contabilida_empresa_5bb061_idx'), models.Index(fields=['empresa', 'periodo'], name='contabilida_empresa_f6566d_idx')],
                'unique_together': {('empresa', 'periodo')},
            },
        ),
        migrations.CreateModel(
            name='PrediccionFinanciera',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('tipo_prediccion', models.CharField(choices=[('INGR', 'Ingresos'), ('GAST', 'Gastos'), ('FLUJ', 'Flujo de Efectivo'), ('PATR', 'Patrimonio'), ('UTIL', 'Utilidad')], max_length=4)),
                ('modelo_usado', models.CharField(choices=[('PROPHET', 'Facebook Prophet'), ('ARIMA', 'ARIMA'), ('LINEAR', 'Regresión Lineal'), ('RF', 'Random Forest')], max_length=10)),
                ('fecha_prediccion', models.DateField(help_text='Fecha para la cual se hace la predicción')),
                ('valor_predicho', models.DecimalField(decimal_places=2, max_digits=20)),
                ('limite_inferior', models.DecimalField(blank=True, decimal_places=2, help_text='Intervalo de confianza inferior', max_digits=20, null=True)),
                ('limite_superior', models.DecimalField(blank=True, decimal_places=2, help_text='Intervalo de confianza superior', max_digits=20, null=True)),
                ('confianza', models.DecimalField(decimal_places=2, default=95.0, help_text='Nivel de confianza en %', max_digits=5)),
                ('fecha_generacion', models.DateTimeField(auto_now_add=True)),
                ('metricas_modelo', models.JSONField(blank=True, help_text='MAE, RMSE, R², etc.', null=True)),
                ('datos_entrenamiento', models.JSONField(blank=True, help_text='Referencia a datos usados', null=True)),
                ('empresa', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='predicciones', to='contabilidad.empresa')),
            ],
            options={
                'verbose_name': 'Predicción Financiera',
                'verbose_name_plural': 'Predicciones Financieras',
                'db_table': 'contabilidad_prediccion_financiera',
                'ordering': ['fecha_prediccion'],
                'indexes': [models.Index(fields=['empresa', 'tipo_prediccion', 'fecha_prediccion'], name='contabilida_empresa_32eb9e_idx'), models.Index(fields=['-fecha_generacion'], name='contabilida_fecha_g_b79ade_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='productoinventario',
            index=models.Index(fields=['empresa', 'sku'], name='contabilida_empresa_427581_idx'),
        ),
        migrations.AddIndex(
            model_name='productoinventario',
            index=models.Index(fields=['empresa', 'activo'], name='contabilida_empresa_13ba21_idx'),
        ),
        migrations.AddIndex(
            model_name='productoinventario',
            index=models.Index(fields=['categoria'], name='contabilida_categor_c84a8d_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='productoinventario',
            unique_together={('empresa', 'sku')},
        ),
        migrations.AddIndex(
            model_name='movimientokardex',
            index=models.Index(fields=['producto', 'fecha'], name='contabilida_product_b18301_idx'),
        ),
        migrations.AddIndex(
            model_name='movimientokardex',
            index=models.Index(fields=['producto', '-fecha', '-id'], name='contabilida_product_991e4c_idx'),
        ),
        migrations.AddIndex(
            model_name='movimientokardex',
            index=models.Index(fields=['tipo_movimiento'], name='contabilida_tipo_mo_1c74b9_idx'),
        ),
        migrations.AddIndex(
            model_name='movimientokardex',
            index=models.Index(fields=['fecha'], name='contabilida_fecha_10fea5_idx'),
        ),
    ]
